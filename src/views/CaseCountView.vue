<!--
  æ¡ˆä»¶æ•¸çµ±è¨ˆåˆ†æè¦–åœ–çµ„ä»¶ (CaseCountView.vue)

  åŠŸèƒ½æ¦‚è¿°ï¼š
  æœ¬çµ„ä»¶å°ˆé–€ç”¨æ–¼åˆ†æé›²æ—ç¸£ç ”ç©¶æ¡ˆçš„æ¡ˆä»¶æ•¸çµ±è¨ˆï¼Œæä¾›å¤šç¶­åº¦çš„æ•¸æ“šè¦–è¦ºåŒ–åˆ†æã€‚

  ä¸»è¦åŠŸèƒ½æ¨¡çµ„ï¼š
  1. ä¸»ç®¡æ©Ÿé—œæ¡ˆä»¶æ•¸çµ±è¨ˆåœ–è¡¨ - é¡¯ç¤ºå‰12åä¸»ç®¡æ©Ÿé—œçš„æ¡ˆä»¶æ•¸æ’å
  2. å¤§å­¸/å­¸é™¢æ¡ˆä»¶æ•¸åˆ†å¸ƒåœ°åœ– - å°ç£åœ°åœ–ä¸Šæ¨™è¨˜å­¸è¡“å–®ä½ä½ç½®å’Œæ¡ˆä»¶æ•¸
  3. ä¸»ç®¡æ©Ÿé—œä¸‹å±¬åŸ·è¡Œå–®ä½åˆ†æ - 12å€‹å°åœ–è¡¨é¡¯ç¤ºå„æ©Ÿé—œçš„åŸ·è¡Œå–®ä½åˆ†å¸ƒ
  4. ä¸»ç®¡æ©Ÿé—œèˆ‡åŸ·è¡Œå–®ä½é—œä¿‚ç¶²çµ¡åœ– - åŠ›å°å‘åœ–é¡¯ç¤ºåˆä½œé—œä¿‚ç¶²çµ¡

  æ•¸æ“šä¾†æºï¼š
  - è¨ˆç•«ä¸»ç®¡æ©Ÿé—œ_normalize.jsonï¼šä¸»ç®¡æ©Ÿé—œåŸºæœ¬è³‡æ–™å’Œçµ±è¨ˆæ•¸æ“š
  - åŸ·è¡Œå–®ä½åç¨±_normalize.jsonï¼šåŸ·è¡Œå–®ä½åŸºæœ¬è³‡æ–™å’Œçµ±è¨ˆæ•¸æ“š
  - åŸ·è¡Œå–®ä½åç¨±_normalize_&_è¨ˆç•«ä¸»ç®¡æ©Ÿé—œ_normalize.jsonï¼šä¸»ç®¡æ©Ÿé—œèˆ‡åŸ·è¡Œå–®ä½çš„æ˜ å°„é—œä¿‚
  - åŸ·è¡Œå–®ä½åç¨±_locations.jsonï¼šåŸ·è¡Œå–®ä½çš„åœ°ç†ä½ç½®åº§æ¨™

  æŠ€è¡“æ¶æ§‹ï¼š
  - Vue 3 Composition APIï¼šçµ„ä»¶é‚è¼¯ç®¡ç†
  - Pinia Storeï¼šæ•¸æ“šç‹€æ…‹ç®¡ç†
  - D3.jsï¼šåœ–è¡¨ç¹ªè£½å’Œæ•¸æ“šè¦–è¦ºåŒ–
  - Leaflet.jsï¼šäº’å‹•å¼åœ°åœ–åŠŸèƒ½
  - Bootstrapï¼šéŸ¿æ‡‰å¼UIæ¡†æ¶
-->

<script>
  import { computed, onMounted, onUnmounted, nextTick } from 'vue';
  import { useDataStore } from '@/stores/dataStore';
  import * as d3 from 'd3';
  import L from 'leaflet';
  import { exportContainerSvgAsPng } from '@/utils/exportImage';

  export default {
    // çµ„ä»¶åç¨±ï¼šç”¨æ–¼ Vue DevTools èª¿è©¦å’Œçµ„ä»¶è­˜åˆ¥
    name: 'CaseCountView',

    setup() {
      // åˆå§‹åŒ–æ•¸æ“šç®¡ç† Store
      // ä½¿ç”¨ Pinia çš„ useDataStore ä¾†ç®¡ç†æ‡‰ç”¨ç¨‹å¼çš„æ•¸æ“šç‹€æ…‹
      const dataStore = useDataStore();

      // ==================== è¨ˆç®—å±¬æ€§ (Computed Properties) ====================
      // è¨ˆç®—å±¬æ€§å…·æœ‰éŸ¿æ‡‰å¼ç‰¹æ€§ï¼Œç•¶ä¾è³´çš„æ•¸æ“šè®ŠåŒ–æ™‚æœƒè‡ªå‹•é‡æ–°è¨ˆç®—
      // åŒæ™‚å…·æœ‰ç·©å­˜ç‰¹æ€§ï¼Œåªæœ‰ä¾è³´è®ŠåŒ–æ™‚æ‰é‡æ–°è¨ˆç®—ï¼Œæé«˜æ€§èƒ½
      // é€™äº›å±¬æ€§æœƒæ ¹æ“šåŸå§‹æ•¸æ“šè‡ªå‹•ç”Ÿæˆåœ–è¡¨æ‰€éœ€çš„æ•¸æ“šçµæ§‹

      /**
       * ä¸»ç®¡æ©Ÿé—œå°åœ–è¡¨æ•¸æ“šçµæ§‹è¨ˆç®—å±¬æ€§
       *
       * åŠŸèƒ½èªªæ˜ï¼š
       * ç‚ºå‰12åä¸»ç®¡æ©Ÿé—œå‰µå»ºå°åœ–è¡¨æ‰€éœ€çš„æ•¸æ“šçµæ§‹ï¼Œæ¯å€‹ä¸»ç®¡æ©Ÿé—œå°æ‡‰ä¸€å€‹å°åœ–è¡¨ï¼Œ
       * é¡¯ç¤ºè©²æ©Ÿé—œä¸‹å±¬åŸ·è¡Œå–®ä½çš„çµ±è¨ˆä¿¡æ¯ã€‚
       *
       * æ•¸æ“šæµç¨‹ï¼š
       * 1. å¾ dataStore ç²å–å‰12åä¸»ç®¡æ©Ÿé—œæ•¸æ“šï¼ˆåŒ…å«ä¸‹å±¬åŸ·è¡Œå–®ä½ä¿¡æ¯ï¼‰
       * 2. ç‚ºæ¯å€‹ä¸»ç®¡æ©Ÿé—œå‰µå»ºæ¨™æº–åŒ–çš„åœ–è¡¨é…ç½®å°è±¡
       * 3. è¿”å›åŒ…å«12å€‹åœ–è¡¨é…ç½®çš„é™£åˆ—ï¼Œä¾›æ¨¡æ¿ä¸­çš„ v-for æŒ‡ä»¤ä½¿ç”¨
       *
       * è¿”å›å€¼çµæ§‹ï¼š
       * é™£åˆ—ä¸­çš„æ¯å€‹å°è±¡åŒ…å«ï¼š
       * - id: å”¯ä¸€çš„DOMå…ƒç´ æ¨™è­˜ç¬¦ï¼Œç”¨æ–¼D3.jsé¸æ“‡å™¨
       * - title: åœ–è¡¨é¡¯ç¤ºæ¨™é¡Œï¼ˆä¸»ç®¡æ©Ÿé—œåç¨±ï¼‰
       * - agencyData: ä¸»ç®¡æ©Ÿé—œçš„åŸºæœ¬çµ±è¨ˆæ•¸æ“š
       * - subUnits: è©²æ©Ÿé—œä¸‹å±¬çš„åŸ·è¡Œå–®ä½åˆ—è¡¨
       *
       * ä½¿ç”¨å ´æ™¯ï¼š
       * åœ¨æ¨¡æ¿ä¸­é€šé v-for æŒ‡ä»¤å‹•æ…‹ç”Ÿæˆ12å€‹å°åœ–è¡¨ï¼Œæ¯å€‹åœ–è¡¨é¡¯ç¤º
       * ä¸€å€‹ä¸»ç®¡æ©Ÿé—œçš„åŸ·è¡Œå–®ä½åˆ†å¸ƒæƒ…æ³ã€‚
       */
      const getSupervisorChartsData = computed(() => {
        // æ­¥é©Ÿ1ï¼šç²å–å‰12åä¸»ç®¡æ©Ÿé—œæ•¸æ“š
        // getTop10AgenciesWithSubUnits è¿”å›æŒ‰æ¡ˆä»¶æ•¸æ’åºçš„ä¸»ç®¡æ©Ÿé—œæ•¸æ“š
        // slice(0, 12) æˆªå–å‰12å€‹å…ƒç´ ï¼Œç¢ºä¿ä¸æœƒè¶…é12å€‹åœ–è¡¨
        const top12AgenciesWithSubUnits = dataStore.getTop10AgenciesWithSubUnits.slice(0, 12);

        // æ­¥é©Ÿ2ï¼šæ•¸æ“šçµæ§‹è½‰æ›
        // ä½¿ç”¨ map æ–¹æ³•å°‡åŸå§‹æ•¸æ“šè½‰æ›ç‚ºåœ–è¡¨æ‰€éœ€çš„æ¨™æº–åŒ–æ ¼å¼
        return top12AgenciesWithSubUnits.map((agency, index) => ({
          // ç”Ÿæˆå”¯ä¸€çš„åœ–è¡¨IDï¼Œæ ¼å¼ï¼šsupervisor-chart-1, supervisor-chart-2, ...
          // é€™å€‹IDç”¨æ–¼D3.jsé¸æ“‡å™¨ï¼Œç¢ºä¿æ¯å€‹åœ–è¡¨éƒ½èƒ½æ­£ç¢ºå®šä½åˆ°å°æ‡‰çš„DOMå…ƒç´ 
          id: `supervisor-chart-${index + 1}`,

          // åœ–è¡¨æ¨™é¡Œï¼šç›´æ¥ä½¿ç”¨ä¸»ç®¡æ©Ÿé—œçš„å®Œæ•´åç¨±
          // ä¸éœ€è¦æˆªçŸ­ï¼Œå› ç‚ºå°åœ–è¡¨çš„æ¨™é¡Œå€åŸŸè¶³å¤ é¡¯ç¤ºå®Œæ•´åç¨±
          title: agency.name,

          // ä¸»ç®¡æ©Ÿé—œçš„æ ¸å¿ƒçµ±è¨ˆæ•¸æ“š
          // åŒ…å«åç¨±ã€æ¡ˆä»¶æ•¸ã€å¹³å‡é ç®—ç­‰é—œéµæŒ‡æ¨™
          agencyData: {
            name: agency.name, // ä¸»ç®¡æ©Ÿé—œå®Œæ•´åç¨±
            å§”æ‰˜æ¡ˆä»¶æ•¸: agency.å§”æ‰˜æ¡ˆä»¶æ•¸, // è©²æ©Ÿé—œçš„ç¸½æ¡ˆä»¶æ•¸
            æ‰€æœ‰ç›¸ç¬¦è³‡æ–™_JSON: agency.æ‰€æœ‰ç›¸ç¬¦è³‡æ–™_JSON, // è©²æ©Ÿé—œçš„å¹³å‡é ç®—é‡‘é¡
          },

          // ä¸‹å±¬åŸ·è¡Œå–®ä½åˆ—è¡¨
          // ä½¿ç”¨ || é‹ç®—ç¬¦æä¾›é»˜èªå€¼ï¼Œé˜²æ­¢æ•¸æ“šç¼ºå¤±å°è‡´çš„éŒ¯èª¤
          // å¦‚æœ subUnits å­˜åœ¨å‰‡ä½¿ç”¨ï¼Œå¦å‰‡ä½¿ç”¨ç©ºé™£åˆ—
          subUnits: agency.subUnits || [],
        }));
      });

      /**
       * èª¿è©¦ä¿¡æ¯è¨ˆç®—å±¬æ€§
       *
       * åŠŸèƒ½èªªæ˜ï¼š
       * æä¾›é–‹ç™¼éšæ®µçš„å•é¡Œè¨ºæ–·å’Œæ•¸æ“šé©—è­‰ä¿¡æ¯ï¼Œå¹«åŠ©é–‹ç™¼è€…äº†è§£çµ„ä»¶çš„é‹è¡Œç‹€æ…‹ã€‚
       * é€™äº›ä¿¡æ¯æœƒé¡¯ç¤ºåœ¨æ¨¡æ¿ä¸­ï¼Œç”¨æ–¼ç›£æ§æ•¸æ“šè¼‰å…¥ç‹€æ…‹ã€éŒ¯èª¤ä¿¡æ¯å’Œæ•¸æ“šçµ±è¨ˆã€‚
       *
       * ä¸»è¦ç”¨é€”ï¼š
       * 1. æ•¸æ“šè¼‰å…¥ç‹€æ…‹ç›£æ§ï¼šé¡¯ç¤ºè¼‰å…¥ä¸­ã€è¼‰å…¥å®Œæˆæˆ–è¼‰å…¥å¤±æ•—çš„ç‹€æ…‹
       * 2. æ•¸æ“šå¯ç”¨æ€§æª¢æŸ¥ï¼šç¢ºèªæ˜¯å¦æœ‰è¶³å¤ çš„æ•¸æ“šä¾†æ¸²æŸ“åœ–è¡¨
       * 3. éŒ¯èª¤ä¿¡æ¯é¡¯ç¤ºï¼šç•¶æ•¸æ“šè¼‰å…¥å¤±æ•—æ™‚ï¼Œå‘ç”¨æˆ¶é¡¯ç¤ºå…·é«”çš„éŒ¯èª¤åŸå› 
       * 4. æ•¸æ“šé‡çµ±è¨ˆï¼šé¡¯ç¤ºè™•ç†å¾Œçš„æ•¸æ“šæ•¸é‡ï¼Œç”¨æ–¼é©—è­‰æ•¸æ“šè™•ç†é‚è¼¯
       *
       * è¿”å›å€¼çµæ§‹ï¼š
       * åŒ…å«å››å€‹é—œéµç‹€æ…‹æŒ‡æ¨™çš„å°è±¡ï¼Œç”¨æ–¼æ¨¡æ¿ä¸­çš„æ¢ä»¶æ¸²æŸ“å’Œç‹€æ…‹é¡¯ç¤º
       */
      const debugInfo = computed(() => ({
        // æ•¸æ“šå¯ç”¨æ€§æª¢æŸ¥
        // é€šéæª¢æŸ¥ä¸»ç®¡æ©Ÿé—œæ•¸æ“šé™£åˆ—çš„é•·åº¦ä¾†åˆ¤æ–·æ˜¯å¦æœ‰å¯ç”¨æ•¸æ“š
        // è¿”å›å€¼ï¼štrue è¡¨ç¤ºæœ‰æ•¸æ“šå¯é¡¯ç¤ºï¼Œfalse è¡¨ç¤ºç„¡æ•¸æ“š
        hasData: dataStore.supervisorAgencies.length > 0,

        // ç¯©é¸å¾Œçš„æœ‰æ•ˆæ•¸æ“šé‡
        // é¡¯ç¤ºç¶“éç¯©é¸å’Œæ’åºå¾Œçš„å‰10åä¸»ç®¡æ©Ÿé—œæ•¸é‡
        // ç”¨æ–¼é©—è­‰æ•¸æ“šè™•ç†é‚è¼¯æ˜¯å¦æ­£ç¢ºï¼Œä»¥åŠç¢ºèªåœ–è¡¨èƒ½é¡¯ç¤ºå¤šå°‘æ•¸æ“š
        topUnitsCount: dataStore.getTopSupervisorAgencies.length,

        // æ•¸æ“šè¼‰å…¥ç‹€æ…‹
        // å¾ dataStore ç²å–ç•¶å‰çš„è¼‰å…¥ç‹€æ…‹
        // è¿”å›å€¼ï¼štrue è¡¨ç¤ºæ­£åœ¨è¼‰å…¥æ•¸æ“šï¼Œfalse è¡¨ç¤ºè¼‰å…¥å®Œæˆ
        loading: dataStore.loading,

        // éŒ¯èª¤ä¿¡æ¯
        // å¾ dataStore ç²å–è¼‰å…¥éç¨‹ä¸­çš„éŒ¯èª¤ä¿¡æ¯
        // è¿”å›å€¼ï¼šæœ‰éŒ¯èª¤æ™‚ç‚ºéŒ¯èª¤è¨Šæ¯å­—ä¸²ï¼Œç„¡éŒ¯èª¤æ™‚ç‚º null
        error: dataStore.error,
      }));

      // ==================== åœ–è¡¨ç¹ªè£½å‡½æ•¸ (Chart Rendering Functions) ====================
      // æœ¬å€åŸŸåŒ…å«æ‰€æœ‰èˆ‡åœ–è¡¨ç¹ªè£½ç›¸é—œçš„å‡½æ•¸ï¼Œä½¿ç”¨ D3.js é€²è¡Œæ•¸æ“šè¦–è¦ºåŒ–
      // æ¯å€‹å‡½æ•¸è² è²¬ç‰¹å®šé¡å‹çš„åœ–è¡¨ï¼ŒåŒ…æ‹¬ä¸»åœ–è¡¨ã€å°åœ–è¡¨ã€åœ°åœ–å’Œç¶²çµ¡åœ–

      /**
       * é€šç”¨åœ–è¡¨ç¹ªè£½å‡½æ•¸ - æ ¹æ“šå‚³å…¥çš„é…ç½®å’Œæ•¸æ“šç¹ªè£½æ¢å½¢åœ–
       *
       * åŠŸèƒ½èªªæ˜ï¼š
       * - ä½¿ç”¨ D3.js å‰µå»ºéŸ¿æ‡‰å¼ SVG æŸ±ç‹€åœ–
       * - æ”¯æ´å‹•æ…‹æ•¸æ“šé‡ï¼ˆä¸»åœ–è¡¨8å€‹ï¼Œå°åœ–è¡¨3å€‹ï¼‰
       * - é˜²æ­¢ bar é‡ç–Šçš„å”¯ä¸€æ¨™è­˜ç¬¦è¨­è¨ˆ
       * - åœ¨åœ–è¡¨ä¸Šæ–¹é¡¯ç¤ºæ•¸å€¼æ¨™ç±¤
       * - å®Œæ•´çš„åº§æ¨™è»¸å’Œæ¨™é¡Œç³»çµ±
       *
       * @param {Object} config - åœ–è¡¨é…ç½®å°è±¡
       * @param {string} config.containerId - DOM å®¹å™¨çš„ ID
       * @param {Array} config.data - è¦é¡¯ç¤ºçš„æ•¸æ“šé™£åˆ—
       * @param {string} config.yAxisLabel - Y è»¸æ¨™ç±¤æ–‡å­—
       * @param {number} [config.containerHeight] - å®¹å™¨ç¸½é«˜åº¦ï¼ˆå¯é¸ï¼‰
       * @param {() => number} [config.getContainerHeight] - ä»¥å‡½æ•¸è¿”å›å®¹å™¨ç¸½é«˜åº¦ï¼ˆå¯é¸ï¼‰
       * @param {() => number} [config.getChartHeight] - ä»¥å‡½æ•¸è¿”å›åœ–è¡¨ bar å€é«˜åº¦ï¼ˆå¯é¸ï¼‰
       */
      const drawChart = (config) => {
        // ==================== åˆå§‹åŒ–å’Œæ¸…ç†éšæ®µ ====================

        // ä½¿ç”¨ D3.js é¸æ“‡å™¨é¸å–ç›®æ¨™ DOM å®¹å™¨
        // d3.select(): D3.js çš„æ ¸å¿ƒæ–¹æ³•ï¼Œé¡ä¼¼ document.querySelector()
        // `#${config.containerId}`: æ¨¡æ¿å­—ä¸²ï¼Œç”Ÿæˆ CSS é¸æ“‡å™¨å¦‚ "#main-chart"
        const container = d3.select(`#${config.containerId}`);

        // æª¢æŸ¥å®¹å™¨æ˜¯å¦å­˜åœ¨æ–¼ DOM ä¸­
        // container.empty(): æª¢æŸ¥é¸æ“‡å™¨æ˜¯å¦æ‰¾åˆ°å…ƒç´ 
        // container.node(): ç²å–å¯¦éš›çš„ DOM ç¯€é»
        // å¦‚æœå®¹å™¨ä¸å­˜åœ¨ï¼Œè¨˜éŒ„éŒ¯èª¤ä¸¦ææ—©è¿”å›ï¼Œé¿å…å¾ŒçºŒéŒ¯èª¤
        if (container.empty() || !container.node()) {
          // eslint-disable-next-line no-console
          console.error(`åœ–è¡¨å®¹å™¨ #${config.containerId} ä¸å­˜åœ¨`);
          return; // ææ—©è¿”å›ï¼Œåœæ­¢å‡½æ•¸åŸ·è¡Œ
        }

        // æ¸…é™¤å®¹å™¨å…§çš„æ‰€æœ‰èˆŠå…ƒç´ ï¼Œé˜²æ­¢é‡è¤‡æ¸²æŸ“é€ æˆçš„è¦–è¦ºé‡ç–Š
        // selectAll('*'): é¸æ“‡å®¹å™¨å…§çš„æ‰€æœ‰å­å…ƒç´ 
        // remove(): D3.js æ–¹æ³•ï¼Œå¾ DOM ä¸­ç§»é™¤é¸ä¸­çš„å…ƒç´ 
        container.selectAll('*').remove();

        // ==================== æ•¸æ“šæº–å‚™éšæ®µ ====================

        // å¾é…ç½®å°è±¡ä¸­æå–åœ–è¡¨æ•¸æ“š
        // config.data: åŒ…å«è¦é¡¯ç¤ºçš„æ•¸æ“šé™£åˆ—ï¼Œæ¯å€‹å…ƒç´ åŒ…å« name å’Œ value å±¬æ€§
        const chartData = config.data;

        // å¾é…ç½®å°è±¡ä¸­æå– Y è»¸æ¨™ç±¤æ–‡å­—ï¼ˆç¾å·²ç§»é™¤Yè»¸æ¨™ç±¤é¡¯ç¤ºï¼‰
        // config.yAxisLabel: å­—ä¸²ï¼ŒåŸç”¨æ–¼é¡¯ç¤ºåœ¨ Y è»¸æ—é‚Šï¼Œç¾åœ¨ä¸å†ä½¿ç”¨

        // æ•¸æ“šæœ‰æ•ˆæ€§æª¢æŸ¥ï¼šç¢ºä¿æ•¸æ“šå·²è¼‰å…¥ä¸”ä¸ç‚ºç©º
        // !chartData: æª¢æŸ¥æ•¸æ“šæ˜¯å¦ç‚º null æˆ– undefined
        // chartData.length === 0: æª¢æŸ¥æ•¸æ“šé™£åˆ—æ˜¯å¦ç‚ºç©º
        // å¦‚æœæ•¸æ“šç„¡æ•ˆï¼Œé¡¯ç¤ºè¼‰å…¥ä¸­æç¤ºä¸¦ææ—©è¿”å›
        if (!chartData || chartData.length === 0) {
          // åœ¨å®¹å™¨ä¸­å‰µå»ºè¼‰å…¥ä¸­æç¤ºå…ƒç´ 
          container
            .append('div') // æ·»åŠ ä¸€å€‹ div å…ƒç´ 
            .attr('class', 'd-flex align-items-center justify-content-center h-100') // Bootstrap é¡åˆ¥ï¼šå‚ç›´æ°´å¹³ç½®ä¸­ï¼Œé«˜åº¦100%
            .style('color', '#666') // è¨­å®šæ–‡å­—é¡è‰²ç‚ºç°è‰²
            .text('è¼‰å…¥ä¸­...'); // è¨­å®šæç¤ºæ–‡å­—
          return; // ææ—©è¿”å›ï¼Œåœæ­¢å‡½æ•¸åŸ·è¡Œ
        }

        // ==================== åœ–è¡¨å°ºå¯¸è¨­å®šéšæ®µ ====================

        // å‹•æ…‹ç²å–å®¹å™¨çš„å¯¦éš›å¯¬åº¦ï¼Œå¯¦ç¾éŸ¿æ‡‰å¼è¨­è¨ˆ
        // getBoundingClientRect(): ç€è¦½å™¨ APIï¼Œç²å–å…ƒç´ çš„ä½ç½®å’Œå°ºå¯¸ä¿¡æ¯
        // .width: æå–å¯¬åº¦å±¬æ€§ï¼Œå–®ä½ç‚ºåƒç´ 
        const containerWidth = container.node().getBoundingClientRect().width;

        // è¨­å®šå®¹å™¨é«˜åº¦ï¼šå„ªå…ˆä½¿ç”¨å‡½æ•¸å›å‚³ï¼Œå¦å‰‡ä½¿ç”¨å‚³å…¥æ•¸å€¼æˆ–é è¨­320
        const containerHeight =
          (typeof config.getContainerHeight === 'function'
            ? config.getContainerHeight()
            : config.containerHeight) || 320;

        // è¨­å®šåœ–è¡¨çš„å…§é‚Šè·ï¼ˆmarginï¼‰ï¼Œå¯¦ç¾æ»¿ç‰ˆé¡¯ç¤ºæ•ˆæœ
        // ä½¿ç”¨å‚³å…¥çš„é‚Šè·è¨­å®šï¼Œå¦‚æœæ²’æœ‰å‚³å…¥å‰‡ä½¿ç”¨æ»¿ç‰ˆé»˜èªå€¼
        // ||: é‚è¼¯æˆ–é‹ç®—ç¬¦ï¼Œæä¾›é»˜èªé…ç½®å°è±¡
        const margin = config.margin || {
          top: 20, // é ‚éƒ¨é‚Šè·ï¼šç‚ºæ•¸å€¼æ¨™ç±¤é ç•™æœ€å°ç©ºé–“
          right: 0, // å³å´é‚Šè·ï¼šè¨­ç‚º0å¯¦ç¾å³é‚Šæ»¿ç‰ˆ
          bottom: 160, // åº•éƒ¨é‚Šè·ï¼šç‚ºXè»¸å‚ç›´æ–‡å­—é ç•™160pxç©ºé–“
          left: 40, // å·¦å´é‚Šè·ï¼šå›ºå®šç‚º32pxä»¥å®¹ç´Yè»¸åˆ»åº¦æ•¸å­—
        };

        // è¨ˆç®—barå€åŸŸçš„å¯¦éš›é«˜åº¦ï¼šå¯ç”±å‡½æ•¸å›å‚³ï¼Œå¦å‰‡é è¨­160px
        const barAreaHeight =
          (typeof config.getChartHeight === 'function' ? config.getChartHeight() : null) || 160;

        // è¨ˆç®—å¯¦éš›å¯ç”¨çš„ç¹ªåœ–å€åŸŸå¤§å°
        // å¾å®¹å™¨ç¸½å¯¬åº¦ä¸­æ¸›å»å·¦å³é‚Šè·ï¼Œå¾—åˆ°åœ–è¡¨å…§å®¹å€åŸŸçš„å¯¬åº¦
        const width = containerWidth - margin.left - margin.right;
        // barå€åŸŸé«˜åº¦å›ºå®šç‚º160pxï¼Œæ¸›å»é ‚éƒ¨é‚Šè·å¾—åˆ°å¯¦éš›ç¹ªåœ–é«˜åº¦
        const height = barAreaHeight - margin.top;

        // ==================== SVG å®¹å™¨å‰µå»ºéšæ®µ ====================

        // å‰µå»º SVG ä¸»å®¹å™¨å…ƒç´ ï¼Œä½œç‚ºæ•´å€‹åœ–è¡¨çš„æ ¹å…ƒç´ 
        const svg = container
          .append('svg') // åœ¨é¸å®šçš„å®¹å™¨ä¸­æ·»åŠ  SVG å…ƒç´ 
          .attr('width', containerWidth) // è¨­å®š SVG çš„ç¸½å¯¬åº¦ï¼ˆåŒ…å«é‚Šè·ï¼‰
          .attr('height', containerHeight); // è¨­å®š SVG çš„ç¸½é«˜åº¦ï¼ˆåŒ…å«é‚Šè·ï¼‰

        // å‰µå»ºä¸»è¦ç¹ªåœ–ç¾¤çµ„ï¼ˆgroupï¼‰ï¼Œä¸¦æ‡‰ç”¨é‚Šè·ä½ç§»
        // æ‰€æœ‰çš„åœ–è¡¨å…ƒç´ éƒ½æœƒåœ¨é€™å€‹ç¾¤çµ„å…§ç¹ªè£½
        // append('g'): æ·»åŠ ä¸€å€‹ SVG ç¾¤çµ„å…ƒç´ 
        // attr('transform', ...): è¨­å®šç¾¤çµ„çš„ä½ç§»è®Šæ›
        // translate(${margin.left},${margin.top}): å°‡ç¾¤çµ„å‘å³ä¸‹ç§»å‹•ï¼Œå‰µé€ é‚Šè·æ•ˆæœ
        const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

        // ==================== æ¯”ä¾‹å°ºè¨­å®šéšæ®µï¼ˆé˜²æ­¢é‡ç–Šçš„é—œéµï¼‰====================

        // åˆ¤æ–·ç•¶å‰æ˜¯å¦ç‚ºä¸»åœ–è¡¨ï¼Œç”¨æ–¼æ±ºå®šé¡¯ç¤ºçš„æ•¸æ“šé‡
        // config.containerId === 'main-chart': æª¢æŸ¥å®¹å™¨ ID æ˜¯å¦ç‚ºä¸»åœ–è¡¨
        // ä¸»åœ–è¡¨é¡¯ç¤º8å€‹é …ç›®ï¼Œå°åœ–è¡¨é¡¯ç¤º3å€‹é …ç›®
        const isMainChart = config.containerId === 'main-chart';

        // è¨­å®šæœ€å¤§æŸ±å­æ•¸é‡ï¼Œæ ¹æ“šåœ–è¡¨é¡å‹å‹•æ…‹èª¿æ•´
        // ä¸‰å…ƒé‹ç®—ç¬¦: æ¢ä»¶ ? çœŸå€¼ : å‡å€¼
        // ä¸»åœ–è¡¨12å€‹ï¼Œå°åœ–è¡¨6å€‹ï¼Œç¢ºä¿å›ºå®šçš„è¦–è¦ºä½ˆå±€
        const maxBars = isMainChart ? 12 : 6;

        // å¾åŸå§‹æ•¸æ“šä¸­æˆªå–å‰ N åæ•¸æ“š
        // slice(0, maxBars): JavaScript é™£åˆ—æ–¹æ³•ï¼Œæˆªå–å¾ç´¢å¼•0é–‹å§‹çš„ maxBars å€‹å…ƒç´ 
        // ç¢ºä¿åªé¡¯ç¤ºæŒ‡å®šæ•¸é‡çš„é …ç›®
        const topData = chartData.slice(0, maxBars);

        // å‰µå»ºå›ºå®šä½ç½®çš„æ•¸æ“šçµæ§‹ï¼Œç¢ºä¿æ¯å€‹ä½ç½®éƒ½æœ‰å”¯ä¸€çš„åç¨±
        // é€™æ˜¯é˜²æ­¢æŸ±å­é‡ç–Šçš„é—œéµè¨­è¨ˆï¼šç‚ºæ¯å€‹ä½ç½®å‰µå»ºå”¯ä¸€æ¨™è­˜ç¬¦
        // ä¸»åœ–è¡¨å›ºå®š8å€‹ä½ç½®ï¼Œå°åœ–è¡¨å›ºå®š3å€‹ä½ç½®
        // Array.from({ length: maxBars }, callback): å‰µå»ºæŒ‡å®šé•·åº¦çš„é™£åˆ—ä¸¦å¡«å……
        const displayData = Array.from({ length: maxBars }, (_, i) => {
          // æª¢æŸ¥ç•¶å‰ä½ç½®æ˜¯å¦æœ‰å¯¦éš›æ•¸æ“š
          if (topData[i]) {
            // æœ‰æ•¸æ“šçš„ä½ç½®ï¼šå±•é–‹åŸå§‹æ•¸æ“šä¸¦æ·»åŠ ä½ç½®ä¿¡æ¯
            return {
              ...topData[i], // ä½¿ç”¨å±•é–‹é‹ç®—ç¬¦è¤‡è£½åŸå§‹æ•¸æ“šçš„æ‰€æœ‰å±¬æ€§ï¼ˆname, value, fullNameç­‰ï¼‰
              position: i, // æ·»åŠ ä½ç½®æ¨™è­˜ç¬¦ï¼Œç”¨æ–¼æ’åºå’Œå®šä½ï¼Œå€¼ç‚º 0, 1, 2, ...
              uniqueName: `pos-${i}-${topData[i].name}`, // å‰µå»ºå”¯ä¸€åç¨±ï¼Œæ ¼å¼: pos-0-æ•™è‚²éƒ¨, pos-1-ç§‘æŠ€éƒ¨, ...
            };
          } else {
            // æ²’æœ‰æ•¸æ“šçš„ä½ç½®ï¼šå‰µå»ºç©ºä½ä½”ä½ç¬¦ï¼Œç¢ºä¿å›ºå®šçš„è¦–è¦ºä½ˆå±€
            return {
              name: `ç©ºä½${i + 1}`, // ç©ºä½é¡¯ç¤ºåç¨±ï¼Œç”¨æ–¼èª¿è©¦å’Œè­˜åˆ¥
              value: 0, // æ•¸å€¼ç‚º0ï¼Œä¸æœƒé¡¯ç¤ºå¯¦éš›çš„æŸ±å­
              fullName: '', // å®Œæ•´åç¨±ç‚ºç©ºå­—ä¸²
              isEmpty: true, // æ¨™è¨˜ç‚ºç©ºä½ï¼Œç”¨æ–¼å¾ŒçºŒéæ¿¾å’Œè™•ç†
              position: i, // ä½ç½®æ¨™è­˜ç¬¦ï¼Œèˆ‡æœ‰æ•¸æ“šçš„ä½ç½®ä¿æŒä¸€è‡´çš„ç´¢å¼•
              uniqueName: `pos-${i}-empty`, // ç©ºä½çš„å”¯ä¸€åç¨±ï¼Œæ ¼å¼: pos-3-empty, pos-4-empty, ...
            };
          }
        });

        // X è»¸æ¯”ä¾‹å°ºè¨­å®šï¼šå¯¦ç¾ justify-content: space-around æ•ˆæœ
        const barWidth = 16; // å›ºå®šæŸ±å­å¯¬åº¦ç‚º16px

        // å¯¦ç¾ space-around ä½ˆå±€çš„è‡ªå®šç¾©æ¯”ä¾‹å°º
        const dataCount = displayData.length;
        const totalBarWidth = dataCount * barWidth; // æ‰€æœ‰barçš„ç¸½å¯¬åº¦
        const availableSpaceWidth = width - totalBarWidth; // å¯ç”¨æ–¼é–“è·çš„å¯¬åº¦
        const spaceUnit = availableSpaceWidth / (dataCount * 2); // æ¯å€‹space-aroundå–®ä½çš„å¯¬åº¦

        // å‰µå»ºè‡ªå®šç¾©çš„ä½ç½®æ˜ å°„å‡½æ•¸
        const xScale = (uniqueName) => {
          const index = displayData.findIndex((d) => d.uniqueName === uniqueName);
          if (index === -1) return 0;
          // space-around: æ¯å€‹å…ƒç´ å‰å¾Œéƒ½æœ‰ spaceUnitï¼Œå†åŠ ä¸Šå‰é¢æ‰€æœ‰barå’Œspaceçš„å¯¬åº¦
          return spaceUnit + index * (barWidth + 2 * spaceUnit) + barWidth / 2;
        };

        // Y è»¸æ¯”ä¾‹å°ºè¨­å®šï¼šä½¿ç”¨ç·šæ€§æ¯”ä¾‹å°ºæ˜ å°„æ•¸å€¼åˆ° SVG é«˜åº¦
        const maxValue = d3.max(topData, (d) => d.value) || 1; // ç²å–æ•¸æ“šæœ€å¤§å€¼

        // è¨ˆç®—é©åˆ5çš„å€æ•¸åˆ»åº¦çš„æœ€å¤§å€¼
        const getRoundedMax = (val) => {
          // æ‰¾åˆ°é©ç•¶çš„é–“éš”ï¼ˆ5çš„å€æ•¸ï¼‰
          let interval = 5;

          // æ ¹æ“šæ•¸å€¼å¤§å°èª¿æ•´é–“éš”
          if (val > 1000) {
            // å°æ–¼å¤§æ–¼1000çš„æ•¸å€¼ï¼Œä½¿ç”¨æ›´å¤§çš„5çš„å€æ•¸é–“éš”
            interval = Math.ceil(val / 5000) * 250; // 250, 500, 750, 1000, 1250...
            if (interval < 500) interval = 500;
          } else if (val > 100) {
            interval = Math.ceil(val / 500) * 25; // 25, 50, 75, 100, 125...
            if (interval < 50) interval = 50;
          } else if (val > 50) {
            interval = 10; // 50-100 ä½¿ç”¨é–“éš”10
          } else if (val > 25) {
            interval = 5; // 25-50 ä½¿ç”¨é–“éš”5
          }

          // ç¢ºä¿é–“éš”æ˜¯5çš„å€æ•¸
          if (interval % 5 !== 0) {
            interval = Math.ceil(interval / 5) * 5;
          }

          // ç¢ºä¿æœ€å¤§å€¼æ˜¯é–“éš”çš„å€æ•¸ï¼Œä¸”ç•¥å¤§æ–¼å¯¦éš›æœ€å¤§å€¼
          const roundedMax = Math.ceil(val / interval) * interval;

          // ç¢ºä¿è‡³å°‘æœ‰åˆç†çš„åˆ»åº¦æ•¸é‡ï¼ˆ2-5æ¢ç·šï¼‰
          if (roundedMax / interval < 2) {
            return interval * 2; // è‡³å°‘2æ¢åˆ»åº¦ç·š
          }

          return roundedMax;
        };

        const roundedMaxValue = getRoundedMax(maxValue);
        const yScale = d3
          .scaleLinear() // å‰µå»ºç·šæ€§æ¯”ä¾‹å°ºï¼Œç”¨æ–¼é€£çºŒæ•¸å€¼æ•¸æ“š
          .domain([0, roundedMaxValue]) // å®šç¾©åŸŸï¼šå¾0åˆ°èˆå…¥å¾Œçš„æœ€å¤§å€¼ï¼Œç¢ºä¿åˆ»åº¦å°é½Š
          .range([height, 0]); // å€¼åŸŸï¼šå¾åœ–è¡¨åº•éƒ¨åˆ°é ‚éƒ¨ï¼ˆSVGåæ¨™ç³»Yè»¸å‘ä¸‹ï¼Œéœ€è¦åè½‰ï¼‰

        // è¨ˆç®—Yè»¸åˆ»åº¦ï¼šåˆ»åº¦å€¼ç‚º5çš„å€æ•¸ï¼Œæœ€å¤š5æ¢ç·šï¼ˆåŒ…å«0ï¼‰
        const calculateYTicks = (roundedMax) => {
          const ticks = [0]; // å§‹çµ‚åŒ…å«0ä½œç‚ºåŸºæº–ç·š

          // è¨ˆç®—é©ç•¶çš„é–“éš”ï¼Œç¢ºä¿ç‚º5çš„å€æ•¸
          let interval = 5;

          // æ ¹æ“šæœ€å¤§å€¼èª¿æ•´é–“éš”ï¼Œç¢ºä¿æœ€å¤š5æ¢ç·š
          while (roundedMax / interval > 4) {
            interval += 5; // å¢åŠ é–“éš”ï¼Œä¿æŒ5çš„å€æ•¸
          }

          // ç”Ÿæˆåˆ»åº¦ï¼Œå¾intervalé–‹å§‹ï¼Œæ¯æ¬¡å¢åŠ interval
          for (let i = interval; i <= roundedMax; i += interval) {
            ticks.push(i);
            if (ticks.length >= 5) break; // æœ€å¤š5æ¢ç·š
          }

          return ticks;
        };

        const yTicks = calculateYTicks(roundedMaxValue);

        // ==================== ç§»é™¤äº’å‹•åŠŸèƒ½éšæ®µ ====================
        // æ ¹æ“šç”¨æˆ¶éœ€æ±‚ï¼Œç§»é™¤äº†åŸæœ‰çš„ tooltip äº’å‹•åŠŸèƒ½
        // ä¸å†å‰µå»º tooltip å…ƒç´ ï¼Œç°¡åŒ–åœ–è¡¨é¡¯ç¤ºï¼Œå°ˆæ³¨æ–¼æ•¸æ“šå‘ˆç¾

        // ==================== æŸ±ç‹€åœ–ç¹ªè£½éšæ®µï¼ˆç„¡é‡ç–Šè¨­è¨ˆï¼‰====================

        // ä½¿ç”¨ D3.js çš„æ•¸æ“šç¶å®šæ¨¡å¼å‰µå»ºæŸ±ç‹€åœ–çš„çŸ©å½¢å…ƒç´ 
        // é€™æ˜¯ D3.js çš„æ ¸å¿ƒæ¦‚å¿µï¼šæ•¸æ“šé©…å‹•æ–‡æª”ï¼ˆData-Driven Documentsï¼‰
        g.selectAll('.bar') // é¸æ“‡æ‰€æœ‰å…·æœ‰ 'bar' é¡åˆ¥çš„å…ƒç´ ï¼ˆåˆå§‹ç‚ºç©ºï¼‰
          .data(displayData) // å°‡ displayData é™£åˆ—èˆ‡é¸ä¸­çš„å…ƒç´ ç¶å®š
          .enter() // è™•ç†æ•¸æ“šå¤šæ–¼å…ƒç´ çš„æƒ…æ³ï¼Œç‚ºæ¯å€‹æ–°æ•¸æ“šé …å‰µå»ºå…ƒç´ 
          .append('rect') // åœ¨ SVG ä¸­æ·»åŠ çŸ©å½¢å…ƒç´ ï¼Œç”¨æ–¼ç¹ªè£½æŸ±å­
          .attr('class', 'bar') // ç‚ºæ¯å€‹çŸ©å½¢æ·»åŠ  'bar' CSS é¡åˆ¥ï¼Œä¾¿æ–¼æ¨£å¼æ§åˆ¶
          // ä½ç½®å’Œå°ºå¯¸è¨­å®šï¼ˆç¢ºä¿ç„¡é‡ç–Šçš„é—œéµè¨­è¨ˆï¼‰
          .attr('x', (d) => xScale(d.uniqueName) - barWidth / 2) // X åº§æ¨™ï¼šç½®ä¸­å°é½Šå›ºå®šå¯¬åº¦æŸ±å­
          .attr('y', (d) => yScale(d.value)) // Y åº§æ¨™ï¼šä½¿ç”¨æ•¸å€¼é€šé yScale è¨ˆç®—ä½ç½®ï¼ˆSVG åæ¨™ç³»ï¼‰
          .attr('width', barWidth) // å¯¬åº¦ï¼šä½¿ç”¨å›ºå®šçš„32pxå¯¬åº¦
          .attr('height', (d) => height - yScale(d.value)) // é«˜åº¦ï¼šå¾åœ–è¡¨åº•éƒ¨åˆ°æ•¸å€¼å°æ‡‰çš„ Y ä½ç½®
          .attr('fill', 'var(--my-color-blue)'); // å¡«å……é¡è‰²ï¼šä½¿ç”¨ CSS è‡ªå®šç¾©å±¬æ€§ï¼Œä¾¿æ–¼ä¸»é¡Œåˆ‡æ›

        // ==================== æ•¸å€¼æ¨™ç±¤æ·»åŠ éšæ®µ ====================
        // åœ¨æ¯å€‹æŸ±å­çš„ä¸Šæ–¹é¡¯ç¤ºå…·é«”æ•¸å€¼ï¼Œä½†åªé¡¯ç¤ºæœ‰å¯¦éš›æ•¸æ“šçš„é …ç›®
        // éæ¿¾æ‰ç©ºä½å’Œæ•¸å€¼ç‚º0çš„é …ç›®ï¼Œé¿å…é¡¯ç¤ºç„¡æ„ç¾©çš„æ¨™ç±¤
        // filter(): JavaScript é™£åˆ—æ–¹æ³•ï¼Œæ ¹æ“šæ¢ä»¶ç¯©é¸å…ƒç´ 
        // !d.isEmpty: ä¸æ˜¯ç©ºä½
        // d.value > 0: æ•¸å€¼å¤§æ–¼0
        const labelData = displayData.filter((d) => !d.isEmpty && d.value > 0);

        // ä½¿ç”¨ D3.js æ•¸æ“šç¶å®šå‰µå»ºæ•¸å€¼æ¨™ç±¤çš„æ–‡å­—å…ƒç´ 
        g.selectAll('.bar-label') // é¸æ“‡æ‰€æœ‰å…·æœ‰ 'bar-label' é¡åˆ¥çš„å…ƒç´ 
          .data(labelData) // ç¶å®šéæ¿¾å¾Œçš„æ¨™ç±¤æ•¸æ“šï¼ˆåªåŒ…å«æœ‰æ•ˆæ•¸æ“šï¼‰
          .enter() // ç‚ºæ–°æ•¸æ“šé …å‰µå»ºå°æ‡‰çš„å…ƒç´ 
          .append('text') // åœ¨ SVG ä¸­æ·»åŠ æ–‡å­—å…ƒç´ 
          .attr('class', 'bar-label') // è¨­å®š CSS é¡åˆ¥ï¼Œä¾¿æ–¼æ¨£å¼æ§åˆ¶
          .attr('x', (d) => {
            // X åº§æ¨™è¨ˆç®—ï¼šå°‡æ¨™ç±¤ç²¾ç¢ºç½®æ–¼å°æ‡‰æŸ±å­çš„æ°´å¹³ä¸­å¤®
            // xScale(d.uniqueName): ä½¿ç”¨å”¯ä¸€åç¨±ç²å–æŸ±å­ä¸­å¿ƒé»çš„ X åº§æ¨™
            // ç”±æ–¼ä½¿ç”¨ scalePoint å’Œå›ºå®šå¯¬åº¦ï¼Œç›´æ¥è¿”å›ä¸­å¿ƒé»ä½ç½®
            return xScale(d.uniqueName);
          })
          .attr('y', (d) => {
            // Y åº§æ¨™è¨ˆç®—ï¼šå°‡æ¨™ç±¤æ”¾ç½®åœ¨æŸ±å­é ‚éƒ¨çš„ä¸Šæ–¹
            // yScale(d.value): ä½¿ç”¨æ•¸å€¼ç²å–æŸ±å­é ‚éƒ¨çš„ Y åº§æ¨™
            // - 5: å‘ä¸Šåç§»5åƒç´ ï¼Œè®“æ¨™ç±¤èˆ‡æŸ±å­é ‚éƒ¨ä¿æŒé©ç•¶è·é›¢ï¼Œé¿å…è¦–è¦ºé‡ç–Š
            // æ³¨æ„ï¼šSVG åº§æ¨™ç³»ä¸­ Y è»¸å‘ä¸‹ç‚ºæ­£ï¼Œæ‰€ä»¥æ¸›æ³•è¡¨ç¤ºå‘ä¸Šç§»å‹•
            return yScale(d.value) - 5;
          })
          .attr('text-anchor', 'middle') // SVG æ–‡å­—éŒ¨é»ï¼šè¨­å®šç‚ºä¸­å¤®å°é½Šï¼Œé…åˆ X åº§æ¨™å¯¦ç¾å®Œç¾ç½®ä¸­
          .style('font-size', '12px') // CSS æ¨£å¼ï¼šè¨­å®šå­—é«”å¤§å°ç‚º12åƒç´ ï¼Œç¢ºä¿å¯è®€æ€§
          .style('fill', '#333') // CSS æ¨£å¼ï¼šè¨­å®šæ–‡å­—é¡è‰²ç‚ºæ·±ç°è‰² (#333)ï¼Œæä¾›è‰¯å¥½çš„å°æ¯”åº¦
          .style('font-weight', 'bold') // CSS æ¨£å¼ï¼šè¨­å®šç²—é«”å­—é‡ï¼Œå¢å¼·æ•¸å€¼çš„è¦–è¦ºé‡è¦æ€§
          .text((d) => d3.format(',')(d.value)); // æ–‡å­—å…§å®¹ï¼šä½¿ç”¨ d3.format(',') æ ¼å¼åŒ–æ•¸å€¼ï¼Œæ·»åŠ åƒåˆ†ä½é€—è™Ÿ

        // ==================== åº§æ¨™è»¸å’Œç¶²æ ¼ç·šç¹ªè£½éšæ®µ ====================

        // ç¹ªè£½æ°´å¹³è™›ç·šç¶²æ ¼ï¼šæ ¹æ“šYè»¸åˆ»åº¦ç¹ªè£½è™›ç·šï¼ŒåŒ…å«åˆ»åº¦0
        g.selectAll('.grid-line')
          .data(yTicks) // ç¶å®šæ‰€æœ‰Yè»¸åˆ»åº¦æ•¸æ“šï¼ˆåŒ…æ‹¬0ï¼‰
          .enter()
          .append('line') // æ·»åŠ ç·šæ¢å…ƒç´ 
          .attr('class', 'grid-line') // è¨­å®šCSSé¡åˆ¥
          .attr('x1', 0) // ç·šæ¢èµ·é»Xåº§æ¨™ï¼šåœ–è¡¨å·¦é‚Š
          .attr('x2', width) // ç·šæ¢çµ‚é»Xåº§æ¨™ï¼šåœ–è¡¨å³é‚Š
          .attr('y1', (d) => yScale(d)) // ç·šæ¢èµ·é»Yåº§æ¨™ï¼šæ ¹æ“šåˆ»åº¦å€¼è¨ˆç®—
          .attr('y2', (d) => yScale(d)) // ç·šæ¢çµ‚é»Yåº§æ¨™ï¼šèˆ‡èµ·é»ç›¸åŒï¼Œå½¢æˆæ°´å¹³ç·š
          .attr('stroke', '#bdbdbd') // çµ±ä¸€ä½¿ç”¨ gray-400 é¡è‰² (#bdbdbd)
          .attr('stroke-width', 1) // è¨­å®šç·šæ¢å¯¬åº¦
          .attr('stroke-dasharray', '3,3') // è¨­å®šè™›ç·šæ¨£å¼ï¼š3åƒç´ å¯¦ç·šï¼Œ3åƒç´ ç©ºç™½
          .attr('opacity', (d) => (d === 0 ? 0.8 : 0.4)); // åˆ»åº¦0æ›´æ˜é¡¯ï¼Œå…¶ä»–æ›´æ·¡

        // X è»¸ç¹ªè£½ï¼šé¡¯ç¤ºä¸»ç®¡æ©Ÿé—œæˆ–åŸ·è¡Œå–®ä½çš„åç¨±æ¨™ç±¤
        const xAxisGroup = g
          .append('g') // åœ¨ä¸»ç¹ªåœ–ç¾¤çµ„ä¸­æ·»åŠ æ–°çš„ç¾¤çµ„å…ƒç´ ï¼Œç”¨æ–¼å®¹ç´ X è»¸
          .attr('transform', `translate(0,${height})`); // è®Šæ›è¨­å®šï¼šå°‡ X è»¸ç¾¤çµ„ç§»å‹•åˆ°åœ–è¡¨åº•éƒ¨

        // ç”±æ–¼ä½¿ç”¨è‡ªå®šç¾© xScale å‡½æ•¸ï¼Œä¸éœ€è¦èª¿ç”¨ d3.axisBottom
        // åˆ»åº¦ç·šå·²è¨­å®šç‚º tickSize(0)ï¼Œæ‰€ä»¥ä¸éœ€è¦é¡å¤–å‰µå»º

        // ç§»é™¤é è¨­çš„ X è»¸æ–‡å­—ï¼Œæ”¹ç‚ºè‡ªè¨‚å‚ç›´æ–‡å­—
        xAxisGroup.selectAll('text').remove();

        // è‡ªè¨‚ X è»¸å‚ç›´æ–‡å­—ï¼šæ”¯æ´æ›è¡Œå’Œå‚ç›´æ’åˆ—
        displayData.forEach((dataItem) => {
          if (!dataItem.isEmpty && dataItem.name) {
            // æ·»åŠ  dataItem.name çš„æª¢æŸ¥
            const x = xScale(dataItem.uniqueName); // å–å¾— bar çš„ x ä½ç½®
            const text = dataItem.name;

            // ç‚ºæ¯å€‹æ©Ÿé—œåç¨±å‰µå»ºå‚ç›´æ–‡å­—ç¾¤çµ„
            const textGroup = xAxisGroup.append('g').attr('transform', `translate(${x}, 20)`); // ç½®ä¸­å°é½Š barï¼Œå‘ä¸‹åç§»20px

            // å°‡æ–‡å­—æŒ‰æ¯10å€‹å­—ç¬¦åˆ†å‰²æˆå¤šè¡Œ
            const lines = [];
            for (let i = 0; i < text.length; i += 10) {
              lines.push(text.substring(i, i + 10));
            }

            // æ ¹æ“šè¡Œæ•¸æ±ºå®šæ°´å¹³æ’åˆ—æ–¹å¼
            const totalLines = lines.length;

            lines.forEach((line, lineIndex) => {
              // è¨ˆç®—æ¯è¡Œçš„æ°´å¹³åç§»ï¼šå°‡å¤šè¡Œç½®ä¸­æ’åˆ—
              const lineOffset =
                totalLines === 1
                  ? 0
                  : totalLines === 2
                    ? lineIndex === 0
                      ? -8
                      : 8
                    : totalLines === 3
                      ? lineIndex === 0
                        ? -12
                        : lineIndex === 1
                          ? 0
                          : 12
                      : // 4è¡Œæˆ–æ›´å¤šæ™‚ï¼Œå‡å‹»åˆ†å¸ƒ
                        (lineIndex - (totalLines - 1) / 2) * 8;

              // åœ¨æ¯è¡Œå…§å‚ç›´æ’åˆ—å­—ç¬¦
              line.split('').forEach((char, charIndex) => {
                textGroup
                  .append('text')
                  .text(char)
                  .attr('x', lineOffset) // æ°´å¹³åç§»ä»¥å¯¦ç¾å¤šè¡Œæ’åˆ—
                  .attr('y', charIndex * (12 + 0.6)) // å­—é«”å¤§å°12px + letter-spacing 0.6px
                  .style('font-size', '12px')
                  .style('font-family', 'Arial, sans-serif')
                  .style('fill', '#333')
                  .style('text-anchor', 'middle'); // æ°´å¹³ç½®ä¸­
              });
            });
          }
        });

        // Y è»¸ç¹ªè£½ï¼šæ•¸å€¼é¡¯ç¤ºåœ¨åœ–è¡¨å…§éƒ¨ï¼Œå¯¦ç¾æ»¿ç‰ˆæ•ˆæœ
        g.append('g') // åœ¨ä¸»ç¹ªåœ–ç¾¤çµ„ä¸­æ·»åŠ æ–°çš„ç¾¤çµ„å…ƒç´ ï¼Œç”¨æ–¼å®¹ç´ Y è»¸
          .call(
            d3
              .axisLeft(yScale)
              .tickValues(yTicks) // ä½¿ç”¨è‡ªå®šç¾©çš„åˆ»åº¦å€¼
              .tickSize(0) // ç§»é™¤å‚ç›´åˆ»åº¦ç·š
              .tickFormat((d) => {
                // è‡ªå®šç¾©æ ¼å¼åŒ–å‡½æ•¸ï¼šé¡¯ç¤ºåŸå§‹æ•¸å­—ï¼Œæ·»åŠ åƒåˆ†ä½é€—è™Ÿ
                return d3.format(',')(d); // ä½¿ç”¨åƒåˆ†ä½é€—è™Ÿæ ¼å¼åŒ–ï¼Œä¸é¡¯ç¤ºkæˆ–M
              }) // æ ¼å¼åŒ–ï¼šé¡¯ç¤ºåŸå§‹æ•¸å­—ï¼Œæ·»åŠ åƒåˆ†ä½é€—è™Ÿ
          )
          .style('font-size', '11px') // CSS æ¨£å¼ï¼šè¨­å®š Y è»¸åˆ»åº¦æ–‡å­—çš„å­—é«”å¤§å°
          .select('.domain')
          .remove(); // ç§»é™¤Yè»¸ä¸»ç·š

        // Yè»¸æ•¸å€¼æ¨™ç±¤ä¿æŒåœ¨å·¦å´æ­£å¸¸ä½ç½®
        g.selectAll('.tick text')
          .style('fill', '#666') // è¨­å®šæ–‡å­—é¡è‰²
          .style('font-weight', 'normal'); // è¨­å®šå­—é‡

        // ç§»é™¤Yè»¸æ¨™ç±¤ï¼šæ ¹æ“šç”¨æˆ¶éœ€æ±‚ï¼Œä¸å†é¡¯ç¤ºYè»¸æ¨™ç±¤
      };

      /**
       * å°åœ–è¡¨æ‰¹æ¬¡ç¹ªè£½å‡½æ•¸
       * åŠŸèƒ½ï¼šéæ­·æ‰€æœ‰ä¸»ç®¡æ©Ÿé—œï¼Œç‚ºæ¯å€‹ä¸»ç®¡æ©Ÿé—œå‰µå»ºå°æ‡‰çš„åŸ·è¡Œå–®ä½çµ±è¨ˆåœ–è¡¨
       *
       * è™•ç†æµç¨‹ï¼š
       * 1. ç²å–å‰8åä¸»ç®¡æ©Ÿé—œçš„æ•¸æ“š
       * 2. ç‚ºæ¯å€‹ä¸»ç®¡æ©Ÿé—œæå–å…¶ä¸‹å‰3ååŸ·è¡Œå–®ä½
       * 3. èª¿ç”¨é€šç”¨åœ–è¡¨ç¹ªè£½å‡½æ•¸å‰µå»ºå°åœ–è¡¨
       *
       * è¨­è¨ˆç‰¹é»ï¼š
       * - çµ±ä¸€ä½¿ç”¨ drawChart å‡½æ•¸ï¼Œç¢ºä¿è¦–è¦ºä¸€è‡´æ€§
       * - å‹•æ…‹æ•¸æ“šè½‰æ›ï¼Œé©é…ä¸åŒçš„æ•¸æ“šçµæ§‹
       * - æ‰¹æ¬¡è™•ç†ï¼Œæé«˜æ¸²æŸ“æ•ˆç‡
       */
      const drawSupervisorCharts = () => {
        // ç²å–è¨ˆç®—å±¬æ€§çš„å€¼ï¼šå‰12åä¸»ç®¡æ©Ÿé—œåŠå…¶å­å–®ä½æ•¸æ“š
        // .value: Vue 3 Composition API ä¸­ç²å–è¨ˆç®—å±¬æ€§å¯¦éš›å€¼çš„èªæ³•
        const chartsData = getSupervisorChartsData.value;

        // æ·»åŠ é˜²è­·æ€§æª¢æŸ¥
        if (!chartsData || chartsData.length === 0) {
          return;
        }

        // éæ­·æ¯å€‹ä¸»ç®¡æ©Ÿé—œçš„æ•¸æ“šï¼Œç‚ºå…¶å‰µå»ºå°æ‡‰çš„å°åœ–è¡¨
        // forEach(): JavaScript é™£åˆ—æ–¹æ³•ï¼Œå°æ¯å€‹å…ƒç´ åŸ·è¡ŒæŒ‡å®šçš„å‡½æ•¸
        chartsData.forEach((chartData) => {
          // æ·»åŠ é˜²è­·æ€§æª¢æŸ¥
          if (!chartData || !chartData.subUnits) {
            return;
          }

          // æ•¸æ“šæ ¼å¼è½‰æ›ï¼šå°‡å­å–®ä½æ•¸æ“šè½‰æ›ç‚ºåœ–è¡¨æ‰€éœ€çš„æ ¼å¼
          // åªå–å‰6ååŸ·è¡Œå–®ä½ï¼Œç¬¦åˆç”¨æˆ¶éœ€æ±‚
          // slice(0, 6): æˆªå–å‰6å€‹å­å–®ä½
          // map(): å°‡æ¯å€‹å­å–®ä½è½‰æ›ç‚ºæ¨™æº–çš„åœ–è¡¨æ•¸æ“šæ ¼å¼
          const subUnitsData = chartData.subUnits
            .slice(0, 6)
            .map((unit) => {
              // æ·»åŠ é˜²è­·æ€§æª¢æŸ¥
              if (!unit || !unit.name_sub) {
                return null;
              }

              return {
                name: unit.name_sub, // æ·»åŠ nameå±¬æ€§ï¼ŒdrawChartå‡½æ•¸éœ€è¦é€™å€‹å±¬æ€§
                uniqueName: unit.name_sub,
                value: unit.å§”æ‰˜æ¡ˆä»¶æ•¸ || 0, // ä½¿ç”¨å§”æ‰˜æ¡ˆä»¶æ•¸ï¼Œæä¾›é»˜èªå€¼
                extra: {
                  count: unit.å§”æ‰˜æ¡ˆä»¶æ•¸ || 0, // ä½¿ç”¨å§”æ‰˜æ¡ˆä»¶æ•¸ï¼Œæä¾›é»˜èªå€¼
                  budget: Math.round(unit.æœ¬æœŸç¶“è²»å¹³å‡_åƒå…ƒ || 0), // ä½¿ç”¨æœ¬æœŸç¶“è²»å¹³å‡_åƒå…ƒï¼Œæä¾›é»˜èªå€¼
                },
              };
            })
            .filter(Boolean); // éæ¿¾æ‰ null å€¼

          // å¦‚æœæ²’æœ‰æœ‰æ•ˆçš„å­å–®ä½æ•¸æ“šï¼Œè·³éé€™å€‹åœ–è¡¨
          if (subUnitsData.length === 0) {
            return;
          }

          // å°åœ–è¡¨é…ç½®å°è±¡ï¼šå®šç¾©åœ–è¡¨çš„æ‰€æœ‰åƒæ•¸å’Œè¨­å®š
          const chartConfig = {
            // å®¹å™¨IDï¼šå°æ‡‰HTMLä¸­çš„å…ƒç´ IDï¼Œç”¨æ–¼D3.jsé¸æ“‡å™¨å®šä½
            containerId: chartData.id,
            // åœ–è¡¨æ•¸æ“šï¼šè½‰æ›å¾Œçš„åŸ·è¡Œå–®ä½æ•¸æ“šé™£åˆ—
            data: subUnitsData,
            // Yè»¸æ¨™ç±¤ï¼šæ ¹æ“šç”¨æˆ¶éœ€æ±‚ï¼Œè¨­ç‚ºç©ºå­—ä¸²ä¸é¡¯ç¤º
            yAxisLabel: '',
            // å®¹å™¨é«˜åº¦ï¼šèˆ‡ä¸»åœ–è¡¨å®Œå…¨ä¸€è‡´ï¼ˆ160px barå€åŸŸ + 160pxæ–‡å­—å€åŸŸï¼‰
            containerHeight: 320,
            // Tooltipæ¨¡æ¿ï¼šå®šç¾©æ‡¸åœæç¤ºçš„HTMLå…§å®¹ï¼ˆé›–ç„¶å·²ç§»é™¤äº’å‹•åŠŸèƒ½ï¼Œä½†ä¿ç•™é…ç½®ï¼‰
            tooltipTemplate: (d) => `
              <strong>${d.fullName}</strong><br/>
              æ¡ˆä»¶æ•¸: ${d.value}<br/>
              å¹³å‡é ç®—: ${d.extra.budget}è¬å…ƒ<br/>
              ä¸»ç®¡æ©Ÿé—œ: ${d.extra.agencyName}
            `,
          };

          // èª¿ç”¨é€šç”¨åœ–è¡¨ç¹ªè£½å‡½æ•¸ï¼šä½¿ç”¨çµ±ä¸€çš„ç¹ªåœ–é‚è¼¯å‰µå»ºå°åœ–è¡¨
          // å‚³å…¥é…ç½®å°è±¡ï¼Œç¢ºä¿æ‰€æœ‰å°åœ–è¡¨å…·æœ‰ä¸€è‡´çš„è¦–è¦ºé¢¨æ ¼
          drawChart(chartConfig);
        });
      };

      // ==================== æ•¸æ“šæº–å‚™å‡½æ•¸å€åŸŸ ====================

      /**
       * ä¸»åœ–è¡¨æ•¸æ“šæº–å‚™å‡½æ•¸
       * åŠŸèƒ½ï¼šå¾æ•¸æ“šå­˜å„²ä¸­æå–ä¸¦è½‰æ›ä¸»ç®¡æ©Ÿé—œæ•¸æ“šï¼Œæº–å‚™ç”¨æ–¼ä¸»åœ–è¡¨é¡¯ç¤º
       *
       * è™•ç†é‚è¼¯ï¼š
       * 1. å¾ dataStore ç²å–æ’åºå¾Œçš„ä¸»ç®¡æ©Ÿé—œæ•¸æ“š
       * 2. æˆªå–å‰8åï¼ˆæ ¹æ“šç”¨æˆ¶æœ€æ–°éœ€æ±‚èª¿æ•´ï¼‰
       * 3. è½‰æ›æ•¸æ“šæ ¼å¼ä»¥é©é…åœ–è¡¨ç¹ªè£½å‡½æ•¸
       * 4. è™•ç†åç¨±é•·åº¦ä»¥é©æ‡‰ X è»¸é¡¯ç¤º
       *
       * @returns {Array} è½‰æ›å¾Œçš„åœ–è¡¨æ•¸æ“šé™£åˆ—
       */
      const prepareMainChartData = () => {
        const topAgencies = dataStore.getTopSupervisorAgencies;

        // æ·»åŠ é˜²è­·æ€§æª¢æŸ¥
        if (!topAgencies || topAgencies.length === 0) {
          return [];
        }

        return topAgencies
          .map((agency) => {
            // ç¢ºä¿ agency å’Œå¿…è¦å±¬æ€§å­˜åœ¨
            if (!agency || !agency.name) {
              return null;
            }

            return {
              name: agency.name, // æ·»åŠ nameå±¬æ€§ç”¨æ–¼é¡¯ç¤º
              uniqueName: agency.name,
              value: agency.å§”æ‰˜æ¡ˆä»¶æ•¸ || 0, // ä½¿ç”¨å§”æ‰˜æ¡ˆä»¶æ•¸ï¼Œæä¾›é»˜èªå€¼
              extra: {
                count: agency.å§”æ‰˜æ¡ˆä»¶æ•¸ || 0, // ä½¿ç”¨å§”æ‰˜æ¡ˆä»¶æ•¸ï¼Œæä¾›é»˜èªå€¼
                budget: agency.æœ¬æœŸç¶“è²»å¹³å‡_åƒå…ƒ || 0, // ä½¿ç”¨æœ¬æœŸç¶“è²»å¹³å‡_åƒå…ƒï¼Œæä¾›é»˜èªå€¼
              },
            };
          })
          .filter(Boolean); // éæ¿¾æ‰ null å€¼
      };

      // ==================== é—œä¿‚åœ–æ•¸æ“šæº–å‚™å‡½æ•¸å€åŸŸ ====================

      /**
       * æº–å‚™é—œä¿‚åœ–çš„ç¯€é»å’Œé€£çµæ•¸æ“š
       * åŠŸèƒ½ï¼šå¾ä¸»ç®¡æ©Ÿé—œèˆ‡åŸ·è¡Œå–®ä½æ˜ å°„æ•¸æ“šä¸­æå–ç¯€é»å’Œé‚Šçš„é—œä¿‚
       *
       * æ•¸æ“šéæ¿¾åŸå‰‡ï¼š
       * åªåŒ…å« "å­¸è¡“å–®ä½":"TRUE" çš„æ•¸æ“šï¼Œç¢ºä¿ç¶²çµ¡åœ–åªé¡¯ç¤ºå­¸è¡“ç›¸é—œçš„åˆä½œé—œä¿‚
       *
       * æ•¸æ“šè™•ç†æµç¨‹ï¼š
       * 1. æ•¸æ“šéæ¿¾ï¼šå¾æ‰€æœ‰ä¸»ç®¡æ©Ÿé—œä¸­ç¯©é¸å‡ºå­¸è¡“å–®ä½ï¼ˆ"å­¸è¡“å–®ä½":"TRUE"ï¼‰
       * 2. é—œä¿‚æ˜ å°„ï¼šæ”¶é›†èˆ‡å­¸è¡“å–®ä½ä¸»ç®¡æ©Ÿé—œæœ‰é—œçš„æ‰€æœ‰æ˜ å°„é—œä¿‚
       * 3. ç¯€é»å‰µå»ºï¼šç‚ºå­¸è¡“å–®ä½ä¸»ç®¡æ©Ÿé—œå’Œç›¸é—œåŸ·è¡Œå–®ä½å‰µå»ºç¯€é»æ•¸æ“š
       * 4. é€£çµå»ºç«‹ï¼šåŸºæ–¼æ˜ å°„é—œä¿‚å‰µå»ºç¯€é»é–“çš„é€£çµï¼Œè¡¨ç¤ºåˆä½œé—œä¿‚
       * 5. æ•¸æ“šé©—è­‰ï¼šç¢ºä¿æ‰€æœ‰é€£çµéƒ½æŒ‡å‘å¯¦éš›å­˜åœ¨çš„ç¯€é»ï¼Œé¿å…æ¸²æŸ“éŒ¯èª¤
       *
       * ç¯€é»é¡å‹å®šç¾©ï¼š
       * - ä¸»ç®¡æ©Ÿé—œç¯€é»ï¼ˆtype: 'agency'ï¼‰ï¼šè—è‰²åœ“åœˆï¼Œä»£è¡¨å­¸è¡“å–®ä½ä¸»ç®¡æ©Ÿé—œ
       * - åŸ·è¡Œå–®ä½ç¯€é»ï¼ˆtype: 'unit'ï¼‰ï¼šæ©˜è‰²åœ“åœˆï¼Œä»£è¡¨èˆ‡å­¸è¡“å–®ä½åˆä½œçš„åŸ·è¡Œå–®ä½
       *
       * æ•¸æ“šçµæ§‹è¨­è¨ˆï¼š
       * æ¯å€‹ç¯€é»åŒ…å«å®Œæ•´çš„çµ±è¨ˆä¿¡æ¯ï¼ˆæ¡ˆä»¶æ•¸ã€é ç®—ã€é …ç›®æ•¸ç­‰ï¼‰ï¼Œ
       * æ¯å€‹é€£çµåŒ…å«é—œä¿‚å¼·åº¦ä¿¡æ¯ï¼ˆåŸºæ–¼æ¡ˆä»¶æ•¸æˆ–é ç®—é‡‘é¡ï¼‰ã€‚
       *
       * è¿”å›å€¼çµæ§‹ï¼š
       * {
       *   nodes: Array,  // ç¯€é»æ•¸æ“šé™£åˆ—ï¼ŒåŒ…å«ä¸»ç®¡æ©Ÿé—œå’ŒåŸ·è¡Œå–®ä½
       *   links: Array   // é€£çµæ•¸æ“šé™£åˆ—ï¼Œè¡¨ç¤ºç¯€é»é–“çš„åˆä½œé—œä¿‚
       * }
       *
       * ä½¿ç”¨å ´æ™¯ï¼š
       * ç‚º D3.js åŠ›å°å‘ç¶²çµ¡åœ–æä¾›æ¨™æº–åŒ–çš„æ•¸æ“šè¼¸å…¥ï¼Œå¯¦ç¾ä¸»ç®¡æ©Ÿé—œèˆ‡
       * åŸ·è¡Œå–®ä½åˆä½œé—œä¿‚çš„è¦–è¦ºåŒ–å±•ç¤ºã€‚
       */
      const prepareNetworkGraphData = () => {
        // 1. ç²å–ä¸»ç®¡æ©Ÿé—œæ•¸æ“šï¼Œæ‰¾å‡ºæ‰€æœ‰å­¸è¡“å–®ä½
        const supervisorAgencies = dataStore.supervisorAgencies;
        if (!supervisorAgencies || supervisorAgencies.length === 0) {
          console.log('æ²’æœ‰ä¸»ç®¡æ©Ÿé—œæ•¸æ“š');
          return { nodes: [], links: [] };
        }

        // 2. å‰µå»ºå­¸è¡“å–®ä½é›†åˆ
        const academicAgencies = new Set();
        supervisorAgencies.forEach((agency) => {
          if (agency.å­¸è¡“å–®ä½ === 'TRUE') {
            academicAgencies.add(agency.name);
          }
        });

        console.log('å­¸è¡“å–®ä½ä¸»ç®¡æ©Ÿé—œ:', [...academicAgencies]);

        // 3. ç²å–æ˜ å°„é—œä¿‚æ•¸æ“š
        const mappingData = dataStore.supervisorExecutingMapping;
        if (!mappingData || mappingData.length === 0) {
          console.log('æ²’æœ‰æ˜ å°„é—œä¿‚æ•¸æ“š');
          return { nodes: [], links: [] };
        }

        // 4. éæ¿¾å‡ºåªèˆ‡å­¸è¡“å–®ä½æœ‰é—œçš„æ˜ å°„é—œä¿‚
        const academicMappings = mappingData.filter((item) => academicAgencies.has(item.name));

        console.log('éæ¿¾å‰æ˜ å°„æ•¸æ“šæ•¸é‡:', mappingData.length);
        console.log('éæ¿¾å¾Œå­¸è¡“å–®ä½æ˜ å°„æ•¸é‡:', academicMappings.length);

        if (academicMappings.length === 0) {
          console.log('æ²’æœ‰å­¸è¡“å–®ä½çš„æ˜ å°„é—œä¿‚');
          return { nodes: [], links: [] };
        }

        // 5. æ”¶é›†æ‰€æœ‰ç›¸é—œçš„åŸ·è¡Œå–®ä½ï¼Œä½†åªä¿ç•™çœŸæ­£çš„å­¸è¡“å–®ä½
        const academicUnits = new Set();
        academicMappings.forEach((item) => {
          // æª¢æŸ¥åŸ·è¡Œå–®ä½æœ¬èº«æ˜¯å¦ç‚ºå­¸è¡“å–®ä½
          const unitData = dataStore.executingUnits.find((unit) => unit.name === item.name_sub);
          if (unitData && unitData.å­¸è¡“å–®ä½ === 'TRUE') {
            academicUnits.add(item.name_sub);
          }
        });

        // 6. å‰µå»ºç¯€é»æ•¸æ“š
        const nodes = [];

        // æ·»åŠ å­¸è¡“å–®ä½ä¸»ç®¡æ©Ÿé—œç¯€é»
        academicAgencies.forEach((agencyName) => {
          // è¨ˆç®—è©²ä¸»ç®¡æ©Ÿé—œçš„çµ±è¨ˆæ•¸æ“š
          const agencyMappings = academicMappings.filter((item) => item.name === agencyName);
          const totalCount = agencyMappings.reduce((sum, item) => sum + (item.å§”æ‰˜æ¡ˆä»¶æ•¸ || 0), 0);
          const totalBudget = agencyMappings.reduce(
            (sum, item) => sum + (item.æœ¬æœŸç¶“è²»å¹³å‡_åƒå…ƒ || 0),
            0
          );
          const projectCount = agencyMappings.length;

          nodes.push({
            id: `agency-${agencyName}`,
            name: agencyName,
            type: 'agency',
            totalCount: totalCount,
            totalBudget: totalBudget,
            projectCount: projectCount,
            meanBudget: projectCount > 0 ? totalBudget / projectCount : 0,
            isAcademic: true, // æ¨™è¨˜ç‚ºå­¸è¡“å–®ä½
            academicStatus: 'TRUE', // å­¸è¡“å–®ä½ç‹€æ…‹
          });
        });

        // æ·»åŠ èˆ‡å­¸è¡“å–®ä½æœ‰é—œä¿‚çš„åŸ·è¡Œå–®ä½ç¯€é»
        academicUnits.forEach((unitName) => {
          // è¨ˆç®—è©²åŸ·è¡Œå–®ä½çš„çµ±è¨ˆæ•¸æ“š
          const unitMappings = academicMappings.filter((item) => item.name_sub === unitName);
          const totalCount = unitMappings.reduce((sum, item) => sum + (item.å§”æ‰˜æ¡ˆä»¶æ•¸ || 0), 0);
          const totalBudget = unitMappings.reduce(
            (sum, item) => sum + (item.æœ¬æœŸç¶“è²»å¹³å‡_åƒå…ƒ || 0),
            0
          );
          const projectCount = unitMappings.length;

          // å¾åŸ·è¡Œå–®ä½æ•¸æ“šä¸­ç²å–å­¸è¡“å–®ä½ç‹€æ…‹
          const unitData = dataStore.executingUnits.find((item) => item.name === unitName);
          const unitAcademicStatus = unitData ? unitData.å­¸è¡“å–®ä½ : 'FALSE';

          nodes.push({
            id: `unit-${unitName}`,
            name: unitName,
            type: 'unit',
            totalCount: totalCount,
            totalBudget: totalBudget,
            projectCount: projectCount,
            meanBudget: projectCount > 0 ? totalBudget / projectCount : 0,
            isAcademic: unitAcademicStatus === 'TRUE',
            academicStatus: unitAcademicStatus, // ä½¿ç”¨ JSON æ•¸æ“šä¸­çš„å­¸è¡“å–®ä½ç‹€æ…‹
          });
        });

        // 7. å‰µå»ºé€£çµæ•¸æ“šï¼Œåªä¿ç•™ç›®æ¨™åŸ·è¡Œå–®ä½æ˜¯å­¸è¡“å–®ä½çš„é€£çµ
        const links = academicMappings
          .filter((item) => academicUnits.has(item.name_sub)) // åªä¿ç•™ç›®æ¨™åŸ·è¡Œå–®ä½åœ¨å­¸è¡“å–®ä½é›†åˆä¸­çš„é€£çµ
          .map((item) => ({
            source: `agency-${item.name}`,
            target: `unit-${item.name_sub}`,
            value: item.å§”æ‰˜æ¡ˆä»¶æ•¸ || 0, // æ¡ˆä»¶æ•¸é é¢ä½¿ç”¨å§”æ‰˜æ¡ˆä»¶æ•¸
          }));

        // 8. è¼¸å‡ºæœ€çµ‚çµæœ
        console.log('æœ€çµ‚ç¯€é»æ•¸é‡:', nodes.length);
        console.log('æœ€çµ‚é€£çµæ•¸é‡:', links.length);
        console.log(
          'æœ€çµ‚ç¯€é»:',
          nodes.map((n) => ({ name: n.name, type: n.type }))
        );

        return { nodes, links };
      };

      // å¤§å­¸/å­¸é™¢æ¡ˆä»¶æ•¸åˆ†å¸ƒåœ–è¡¨åŠŸèƒ½å·²ç§»é™¤ï¼Œæ¢å¾©ç‚ºåœ°åœ–åŠŸèƒ½

      /**
       * é—œä¿‚ç¶²çµ¡åœ–ç¹ªè£½å‡½æ•¸
       *
       * åŠŸèƒ½èªªæ˜ï¼š
       * ä½¿ç”¨ D3.js åŠ›å°å‘å¸ƒå±€ç®—æ³•å‰µå»ºä¸»ç®¡æ©Ÿé—œèˆ‡åŸ·è¡Œå–®ä½çš„é—œä¿‚ç¶²çµ¡åœ–ï¼Œ
       * é€šéç¯€é»å’Œé€£çµçš„è¦–è¦ºåŒ–å±•ç¤ºï¼Œå¹«åŠ©ç”¨æˆ¶ç†è§£å­¸è¡“å–®ä½ä¹‹é–“çš„åˆä½œé—œä¿‚
       * å’Œç¶²çµ¡çµæ§‹ã€‚é€™å€‹åœ–è¡¨æ˜¯æ•´å€‹åˆ†æç³»çµ±çš„æ ¸å¿ƒè¦–è¦ºåŒ–çµ„ä»¶ä¹‹ä¸€ã€‚
       *
       * æŠ€è¡“å¯¦ç¾æ¶æ§‹ï¼š
       * - å¸ƒå±€å¼•æ“ï¼šD3.js åŠ›å°å‘æ¨¡æ“¬ï¼Œå¯¦ç¾ç¯€é»çš„è‡ªå‹•å¸ƒå±€å’Œå‹•æ…‹èª¿æ•´
       * - è¦–è¦ºåŒ–è¨­è¨ˆï¼šSVG ç¹ªè£½ï¼Œæ”¯æŒç¸®æ”¾ã€æ‹–æ‹½ç­‰äº’å‹•æ“ä½œ
       * - æ•¸æ“šé©…å‹•ï¼šåŸºæ–¼ prepareNetworkGraphData å‡½æ•¸è™•ç†çš„æ¨™æº–åŒ–æ•¸æ“š
       * - éŸ¿æ‡‰å¼è¨­è¨ˆï¼šè‡ªå‹•é©æ‡‰å®¹å™¨å°ºå¯¸ï¼Œæ”¯æŒä¸åŒè¢å¹•åˆ†è¾¨ç‡
       *
       * è¦–è¦ºè¨­è¨ˆç‰¹é»ï¼š
       * - ç¯€é»é¡å‹ç·¨ç¢¼ï¼šè—è‰²åœ“åœˆä»£è¡¨ä¸»ç®¡æ©Ÿé—œï¼Œæ©˜è‰²åœ“åœˆä»£è¡¨åŸ·è¡Œå–®ä½
       * - å¤§å°ç·¨ç¢¼ï¼šåœ“åœˆå¤§å°èˆ‡æ¡ˆä»¶æ•¸æˆæ­£æ¯”ï¼Œç›´è§€åæ˜ æ¥­å‹™è¦æ¨¡
       * - é€£çµè¨­è¨ˆï¼šç°è‰²ç·šæ¢è¡¨ç¤ºåˆä½œé—œä¿‚ï¼Œç·šæ¢ç²—ç´°åæ˜ é—œä¿‚å¼·åº¦
       * - å¸ƒå±€ç®—æ³•ï¼šåŠ›å°å‘å¸ƒå±€è‡ªå‹•å„ªåŒ–ç¯€é»ä½ç½®ï¼Œé¿å…é‡ç–Š
       *
       * äº’å‹•åŠŸèƒ½ï¼š
       * - ç¯€é»æ‹–æ‹½ï¼šç”¨æˆ¶å¯ä»¥æ‹–æ‹½ç¯€é»èª¿æ•´ä½ç½®ï¼Œå„ªåŒ–è¦–è¦ºæ•ˆæœ
       * - æ‡¸åœæ•ˆæœï¼šæ»‘é¼ æ‡¸åœæ™‚é¡¯ç¤ºè©³ç´°çš„çµ±è¨ˆä¿¡æ¯
       * - ç¸®æ”¾å¹³ç§»ï¼šæ”¯æŒåœ–è¡¨çš„ç¸®æ”¾å’Œå¹³ç§»æ“ä½œï¼Œä¾¿æ–¼æŸ¥çœ‹ç´°ç¯€
       * - å‹•æ…‹æ›´æ–°ï¼šç¯€é»ä½ç½®æœƒæ ¹æ“šåŠ›å°å‘ç®—æ³•è‡ªå‹•èª¿æ•´ï¼Œå½¢æˆæœ€ä½³å¸ƒå±€
       *
       * æ€§èƒ½å„ªåŒ–ï¼š
       * - ç¯€é»æ•¸é‡æ§åˆ¶ï¼šåªé¡¯ç¤ºå­¸è¡“å–®ä½ç›¸é—œçš„ç¯€é»ï¼Œé¿å…åœ–è¡¨éæ–¼è¤‡é›œ
       * - å‹•ç•«å„ªåŒ–ï¼šä½¿ç”¨ D3.js çš„éæ¸¡å‹•ç•«ï¼Œæå‡ç”¨æˆ¶é«”é©—
       * - è¨˜æ†¶é«”ç®¡ç†ï¼šåŠæ™‚æ¸…ç†èˆŠçš„åœ–è¡¨å…ƒç´ ï¼Œé˜²æ­¢è¨˜æ†¶é«”æ´©æ¼
       */
      const drawNetworkGraph = () => {
        // ç²å–åœ–è¡¨æ•¸æ“šï¼šç¯€é»å’Œé€£çµé—œä¿‚
        const graphData = prepareNetworkGraphData();

        // æ•¸æ“šé©—è­‰ï¼šå¦‚æœæ²’æœ‰ç¯€é»ï¼Œé¡¯ç¤ºæç¤ºä¿¡æ¯
        if (!graphData.nodes || graphData.nodes.length === 0) {
          const container = d3.select('#network-graph');
          container.html('<div class="text-center text-muted p-5">æš«ç„¡é—œä¿‚æ•¸æ“š</div>');
          return;
        }

        // æ¸…é™¤èˆŠçš„åœ–è¡¨å…§å®¹
        const container = d3.select('#network-graph');
        container.selectAll('*').remove();

        // ç²å–å®¹å™¨å°ºå¯¸ï¼šå‹•æ…‹é©æ‡‰å®¹å™¨å¤§å°
        const containerRect = container.node().getBoundingClientRect();
        const width = containerRect.width;
        const height = 600; // å›ºå®šé«˜åº¦ï¼Œèˆ‡CSSè¨­å®šä¸€è‡´

        // å‰µå»º SVG å®¹å™¨ï¼šé—œä¿‚åœ–çš„æ ¹å…ƒç´ 
        const svg = container.append('svg').attr('width', width).attr('height', height);

        // å‰µå»ºä¸»ç¹ªåœ–ç¾¤çµ„ï¼šæ‰€æœ‰åœ–å½¢å…ƒç´ çš„å®¹å™¨
        const g = svg.append('g');

        // æ·»åŠ ç¸®æ”¾åŠŸèƒ½ï¼šå…è¨±ç”¨æˆ¶ç¸®æ”¾å’Œå¹³ç§»åœ–è¡¨
        const zoom = d3
          .zoom()
          .scaleExtent([0.1, 3]) // ç¸®æ”¾ç¯„åœï¼š0.1x åˆ° 3x
          .on('zoom', (event) => {
            // æ‡‰ç”¨è®Šæ›ï¼šç¸®æ”¾å’Œå¹³ç§»
            g.attr('transform', event.transform);
          });

        // å°‡ç¸®æ”¾è¡Œç‚ºç¶å®šåˆ° SVG å…ƒç´ 
        svg.call(zoom);

        // è¨­å®šåŠ›å°å‘æ¨¡æ“¬ï¼šæ§åˆ¶ç¯€é»å’Œé€£çµçš„ç‰©ç†è¡Œç‚º
        const simulation = d3
          .forceSimulation(graphData.nodes)
          .force(
            'link',
            d3
              .forceLink(graphData.links)
              .id((d) => d.id) // ä½¿ç”¨ç¯€é» ID ä¾†åŒ¹é…é€£çµ
              .distance(100)
          ) // é€£çµçš„ç†æƒ³é•·åº¦
          .force('charge', d3.forceManyBody().strength(-300)) // ç¯€é»é–“çš„æ’æ–¥åŠ›
          .force('center', d3.forceCenter(width / 2, height / 2)) // å°‡åœ–å½¢ç½®æ–¼ä¸­å¿ƒ
          .force(
            'collision',
            d3.forceCollide().radius((d) => {
              // è¨ˆç®—ç¯€é»åŠå¾‘ï¼šè®“ç¯€é»é¢ç©èˆ‡æ¡ˆä»¶æ•¸æˆæ­£æ¯”
              // ç›®æ¨™ï¼š1500æ¡ˆä»¶æ•¸å°æ‡‰50Ã—50Ã—Ï€ = 2500Ï€å¹³æ–¹åƒç´ 
              // æ‰€ä»¥1æ¡ˆä»¶æ•¸ = 1å¹³æ–¹åƒç´ 
              // é¢ç© = æ¡ˆä»¶æ•¸ï¼ŒåŠå¾‘ = âˆš(é¢ç©/Ï€)
              const scaleMultiplier = 1.0; // æ”¾å¤§å€æ•¸ï¼š1.0 = åŸå§‹å¤§å°ï¼Œ2.0 = æ”¾å¤§2å€ï¼Œ0.5 = ç¸®å°2å€
              const area = d.totalCount * scaleMultiplier; // é¢ç© = æ¡ˆä»¶æ•¸ Ã— æ”¾å¤§å€æ•¸
              const radius = Math.sqrt(area / Math.PI);
              return Math.max(5, Math.min(radius, 100)); // æœ€å°åŠå¾‘5pxï¼ˆç›´å¾‘10pxï¼‰ï¼Œæœ€å¤§åŠå¾‘100pxï¼ˆç›´å¾‘200pxï¼‰
            })
          ); // é˜²æ­¢ç¯€é»é‡ç–Šï¼Œèª¿æ•´ç¢°æ’åŠå¾‘èˆ‡åœ“åœˆå¤§å°ä¸€è‡´

        // ç¹ªè£½é€£çµç·šï¼šè¡¨ç¤ºä¸»ç®¡æ©Ÿé—œèˆ‡åŸ·è¡Œå–®ä½çš„é—œä¿‚
        const links = g
          .append('g')
          .attr('class', 'links')
          .selectAll('line')
          .data(graphData.links)
          .enter()
          .append('line')
          .attr('stroke', '#999') // ç°è‰²ç·šæ¢
          .attr('stroke-opacity', 0.6) // åŠé€æ˜æ•ˆæœ
          .attr('stroke-width', 2); // å›ºå®šç·šæ¢å¯¬åº¦

        // ç¹ªè£½ç¯€é»ï¼šä¸»ç®¡æ©Ÿé—œå’ŒåŸ·è¡Œå–®ä½çš„åœ“åœˆ
        const nodes = g
          .append('g')
          .attr('class', 'nodes')
          .selectAll('circle')
          .data(graphData.nodes)
          .enter()
          .append('circle')
          .attr('r', (d) => {
            // è¨ˆç®—ç¯€é»åŠå¾‘ï¼šè®“ç¯€é»é¢ç©èˆ‡æ¡ˆä»¶æ•¸æˆæ­£æ¯”
            // ç›®æ¨™ï¼š1500æ¡ˆä»¶æ•¸å°æ‡‰50Ã—50Ã—Ï€ = 2500Ï€å¹³æ–¹åƒç´ 
            // æ‰€ä»¥1æ¡ˆä»¶æ•¸ = 1å¹³æ–¹åƒç´ 
            // é¢ç© = æ¡ˆä»¶æ•¸ï¼ŒåŠå¾‘ = âˆš(é¢ç©/Ï€)
            const scaleMultiplier = 5.0; // æ”¾å¤§å€æ•¸ï¼š1.0 = åŸå§‹å¤§å°ï¼Œ2.0 = æ”¾å¤§2å€ï¼Œ0.5 = ç¸®å°2å€
            const area = d.totalCount * scaleMultiplier; // é¢ç© = æ¡ˆä»¶æ•¸ Ã— æ”¾å¤§å€æ•¸
            const radius = Math.sqrt(area / Math.PI);
            return Math.max(5, Math.min(radius, 100)); // æœ€å°åŠå¾‘5pxï¼ˆç›´å¾‘10pxï¼‰ï¼Œæœ€å¤§åŠå¾‘100pxï¼ˆç›´å¾‘200pxï¼‰
          })
          .attr('fill', (d) => (d.type === 'agency' ? '#4a90e2' : '#f5a623')) // è—è‰²ï¼šæ©Ÿé—œï¼Œæ©˜è‰²ï¼šå–®ä½
          .attr('stroke', '#fff') // ç™½è‰²é‚Šæ¡†
          .attr('stroke-width', 2) // é‚Šæ¡†å¯¬åº¦
          .style('cursor', 'pointer') // æ»‘é¼ æ¸¸æ¨™è®Šç‚ºæ‰‹å‹
          .call(
            d3
              .drag() // æ·»åŠ æ‹–æ‹½åŠŸèƒ½
              .on('start', dragstarted) // æ‹–æ‹½é–‹å§‹
              .on('drag', dragged) // æ‹–æ‹½é€²è¡Œä¸­
              .on('end', dragended)
          ); // æ‹–æ‹½çµæŸ

        // æ·»åŠ ç¯€é»æ¨™ç±¤ï¼šé¡¯ç¤ºæ©Ÿé—œæˆ–å–®ä½åç¨±
        const labels = g
          .append('g')
          .attr('class', 'labels')
          .selectAll('text')
          .data(graphData.nodes)
          .enter()
          .append('text')
          .text((d) => {
            // æˆªçŸ­éé•·çš„åç¨±ï¼šè¶…é10å€‹å­—ç¬¦å‰‡æˆªæ–·ä¸¦åŠ çœç•¥è™Ÿ
            return d.name.length > 10 ? d.name.substring(0, 10) + '...' : d.name;
          })
          .attr('font-size', '12px')
          .attr('font-family', 'Arial, sans-serif')
          .attr('fill', '#333')
          .attr('text-anchor', 'middle') // æ–‡å­—ç½®ä¸­å°é½Š
          .attr('dy', '0.35em') // å‚ç›´ç½®ä¸­èª¿æ•´
          .style('pointer-events', 'none'); // æ¨™ç±¤ä¸éŸ¿æ‡‰æ»‘é¼ äº‹ä»¶

        // å‰µå»ºè‡ªå®šç¾© tooltip å…ƒç´ 
        const tooltip = d3
          .select('body')
          .append('div')
          .attr('class', 'network-tooltip')
          .style('position', 'absolute')
          .style('padding', '10px')
          .style('background', 'rgba(0, 0, 0, 0.8)')
          .style('color', 'white')
          .style('border-radius', '5px')
          .style('font-size', '12px')
          .style('line-height', '1.4')
          .style('pointer-events', 'none')
          .style('opacity', 0)
          .style('z-index', '1000');

        // æ·»åŠ æ»‘é¼ äº‹ä»¶ï¼šæ‡¸åœé¡¯ç¤ºè©³ç´°è³‡è¨Š
        nodes
          .on('mouseover', function (event, d) {
            // é«˜äº®ç•¶å‰ç¯€é»
            d3.select(this)
              .transition()
              .duration(200)
              .attr('stroke-width', 3)
              .attr('stroke', '#333');

            // æº–å‚™é¡¯ç¤ºçš„è³‡è¨Š
            const typeText = d.type === 'agency' ? 'ä¸»ç®¡æ©Ÿé—œ' : 'åŸ·è¡Œå–®ä½';

            let tooltipContent = `
              <div style="font-weight: bold; margin-bottom: 5px;">${typeText}</div>
              <div style="font-size: 14px; font-weight: bold; margin-bottom: 8px;">${d.name}</div>
              <div>æ¡ˆä»¶æ•¸: <span style="color: #4a90e2;">${d.totalCount}</span></div>
              <div>å¹³å‡é‡‘é¡: <span style="color: #50e3c2;">${Math.round(d.totalBudget / d.projectCount || 0).toLocaleString()}</span>(åƒå…ƒ)</div>
            `;

            // å¦‚æœæ˜¯åŸ·è¡Œå–®ä½ï¼Œé¡¯ç¤ºé¡å¤–è³‡è¨Š
            if (d.type === 'unit') {
              tooltipContent += `<div style="margin-top: 5px; color: #f5a623;">ğŸ« å­¸è¡“æ©Ÿæ§‹</div>`;
            }

            // é¡¯ç¤º tooltip
            tooltip
              .html(tooltipContent)
              .style('opacity', 1)
              .style('left', event.pageX + 10 + 'px')
              .style('top', event.pageY - 10 + 'px');
          })
          .on('mousemove', function (event) {
            // è·Ÿéš¨æ»‘é¼ ç§»å‹•
            tooltip.style('left', event.pageX + 10 + 'px').style('top', event.pageY - 10 + 'px');
          })
          .on('mouseout', function () {
            // æ¢å¾©ç¯€é»æ¨£å¼
            d3.select(this)
              .transition()
              .duration(200)
              .attr('stroke-width', 2)
              .attr('stroke', '#fff');

            // éš±è— tooltip
            tooltip.transition().duration(200).style('opacity', 0);
          });

        // åŠ›å°å‘æ¨¡æ“¬çš„æ¯ä¸€å¹€æ›´æ–°ï¼šæ›´æ–°ç¯€é»å’Œé€£çµä½ç½®
        simulation.on('tick', () => {
          // æ›´æ–°é€£çµç·šçš„ä½ç½®
          links
            .attr('x1', (d) => d.source.x)
            .attr('y1', (d) => d.source.y)
            .attr('x2', (d) => d.target.x)
            .attr('y2', (d) => d.target.y);

          // æ›´æ–°ç¯€é»åœ“åœˆçš„ä½ç½®
          nodes.attr('cx', (d) => d.x).attr('cy', (d) => d.y);

          // æ›´æ–°æ¨™ç±¤æ–‡å­—çš„ä½ç½®
          labels.attr('x', (d) => d.x).attr('y', (d) => d.y);
        });

        // æ‹–æ‹½äº‹ä»¶è™•ç†å‡½æ•¸ï¼šæ‹–æ‹½é–‹å§‹æ™‚é‡æ–°å•Ÿå‹•æ¨¡æ“¬
        function dragstarted(event, d) {
          if (!event.active) simulation.alphaTarget(0.3).restart();
          d.fx = d.x; // å›ºå®š X åº§æ¨™
          d.fy = d.y; // å›ºå®š Y åº§æ¨™
        }

        // æ‹–æ‹½é€²è¡Œä¸­ï¼šæ›´æ–°ç¯€é»ä½ç½®
        function dragged(event, d) {
          d.fx = event.x; // æ›´æ–°å›ºå®šçš„ X åº§æ¨™
          d.fy = event.y; // æ›´æ–°å›ºå®šçš„ Y åº§æ¨™
        }

        // æ‹–æ‹½çµæŸï¼šé‡‹æ”¾ç¯€é»å›ºå®šä½ç½®
        function dragended(event, d) {
          if (!event.active) simulation.alphaTarget(0); // åœæ­¢æ¨¡æ“¬çš„ç†±é‡å•Ÿ
          d.fx = null; // é‡‹æ”¾ X åº§æ¨™å›ºå®š
          d.fy = null; // é‡‹æ”¾ Y åº§æ¨™å›ºå®š
        }
      };

      // ==================== åœ°åœ–åˆå§‹åŒ–å‡½æ•¸å€åŸŸ ====================

      /**
       * å°ç£åœ°åœ–åˆå§‹åŒ–å‡½æ•¸
       * åŠŸèƒ½ï¼šä½¿ç”¨ Leaflet.js å‰µå»ºäº’å‹•å¼åœ°åœ–ï¼Œé¡¯ç¤ºå¤§å­¸/å­¸é™¢åŸ·è¡Œå–®ä½çš„åœ°ç†åˆ†å¸ƒ
       *
       * åœ°åœ–ç‰¹è‰²ï¼š
       * - ä»¥å°ç£ç‚ºä¸­å¿ƒçš„åœ°ç†è¦–åœ–
       * - åœ“åœˆæ¨™è¨˜ä»£è¡¨åŸ·è¡Œå–®ä½ä½ç½®
       * - åœ“åœˆå¤§å°åæ˜ æ¡ˆä»¶æ•¸é‡
       * - é»æ“Šåœ“åœˆé¡¯ç¤ºè©³ç´°ä¿¡æ¯
       * - æ»¿ç‰ˆé¡¯ç¤ºè¨­è¨ˆï¼ˆå·¦å³ä¸‹é‚Šç·£å°é½Šå®¹å™¨ï¼‰
       *
       * æ•¸æ“šç¯©é¸ï¼š
       * - åªé¡¯ç¤ºåŒ…å«ã€Œå¤§å­¸ã€æˆ–ã€Œå­¸é™¢ã€é—œéµå­—çš„åŸ·è¡Œå–®ä½
       * - éæ¿¾æ‰æ²’æœ‰åœ°ç†åº§æ¨™çš„å–®ä½
       */
      /**
       * å°ç£åœ°åœ–åˆå§‹åŒ–å‡½æ•¸
       *
       * åŠŸèƒ½èªªæ˜ï¼š
       * å‰µå»ºäº’å‹•å¼å°ç£åœ°åœ–ï¼Œåœ¨åœ°åœ–ä¸Šæ¨™è¨˜æ‰€æœ‰å­¸è¡“å–®ä½ï¼ˆå¤§å­¸/å­¸é™¢ï¼‰çš„åœ°ç†ä½ç½®ï¼Œ
       * ä¸¦é€šéåœ“åœˆå¤§å°è¦–è¦ºåŒ–é¡¯ç¤ºå„å–®ä½çš„æ¡ˆä»¶æ•¸è¦æ¨¡ã€‚é€™ç‚ºç”¨æˆ¶æä¾›äº†
       * å­¸è¡“å–®ä½åœ°ç†åˆ†å¸ƒçš„ç›´è§€è¦–åœ–ï¼Œå¹«åŠ©ç†è§£ç ”ç©¶æ¡ˆçš„åœ°ç†åˆ†å¸ƒæ¨¡å¼ã€‚
       *
       * æŠ€è¡“å¯¦ç¾æ¶æ§‹ï¼š
       * - åœ°åœ–å¼•æ“ï¼šä½¿ç”¨ Leaflet.js å‰µå»ºäº’å‹•å¼åœ°åœ–
       * - åœ°åœ–æœå‹™ï¼šåŸºæ–¼ OpenStreetMap çš„å…è²»åœ°åœ–æœå‹™
       * - è¦–è¦ºåŒ–è¨­è¨ˆï¼šåœ“åœˆå¤§å°èˆ‡æ¡ˆä»¶æ•¸æˆæ­£æ¯”ï¼Œå¯¦ç¾æ•¸æ“šçš„è¦–è¦ºåŒ–è¡¨é”
       * - äº’å‹•åŠŸèƒ½ï¼šæ”¯æŒç¸®æ”¾ã€æ‹–æ‹½ã€æ‡¸åœæ•ˆæœå’Œé»æ“Šå½ˆå‡ºè¦–çª—
       *
       * æ•¸æ“šè™•ç†é‚è¼¯ï¼š
       * 1. å¾ dataStore ç²å–å­¸è¡“å–®ä½æ•¸æ“šï¼ˆ"å­¸è¡“å–®ä½":"TRUE"ï¼‰
       * 2. çµåˆåœ°ç†ä½ç½®æ•¸æ“šï¼Œéæ¿¾å‡ºæœ‰åº§æ¨™ä¿¡æ¯çš„å–®ä½
       * 3. æ ¹æ“šæ¡ˆä»¶æ•¸è¨ˆç®—åœ“åœˆå¤§å°ï¼Œå¯¦ç¾æ•¸æ“šçš„è¦–è¦ºåŒ–è¡¨é”
       * 4. ç‚ºæ¯å€‹å–®ä½å‰µå»ºäº’å‹•å¼æ¨™è¨˜ï¼ŒåŒ…å«è©³ç´°çš„çµ±è¨ˆä¿¡æ¯
       *
       * è¦–è¦ºè¨­è¨ˆç‰¹é»ï¼š
       * - åœ“åœˆæ¨™è¨˜ï¼šä½¿ç”¨ç´…è‰²åœ“åœˆæ¨™è¨˜å­¸è¡“å–®ä½ä½ç½®
       * - å¤§å°ç·¨ç¢¼ï¼šåœ“åœˆå¤§å°åæ˜ å§”æ‰˜æ¡ˆä»¶æ•¸çš„ç›¸å°è¦æ¨¡
       * - é€æ˜åº¦è¨­è¨ˆï¼šåŠé€æ˜å¡«å……ï¼Œç¢ºä¿åœ°åœ–åº•å±¤å¯è¦‹
       * - æ‡¸åœæ•ˆæœï¼šæ»‘é¼ æ‡¸åœæ™‚åœ“åœˆè®Šå¤§è®Šæ·±ï¼Œæå‡ç”¨æˆ¶é«”é©—
       *
       * å½ˆå‡ºè¦–çª—å…§å®¹ï¼š
       * é»æ“Šåœ“åœˆæ™‚é¡¯ç¤ºåŒ…å«å–®ä½åç¨±ã€å§”æ‰˜æ¡ˆä»¶æ•¸å’Œå¹³å‡é‡‘é¡çš„è©³ç´°ä¿¡æ¯
       */
      const initMap = () => {
        // é˜²æ­¢é‡è¤‡åˆå§‹åŒ–ï¼šæª¢æŸ¥åœ°åœ–å®¹å™¨æ˜¯å¦å·²å­˜åœ¨ Leaflet å¯¦ä¾‹
        const mapContainer = document.getElementById('taiwan-map');

        // æª¢æŸ¥å®¹å™¨æ˜¯å¦å­˜åœ¨
        if (!mapContainer) {
          console.warn('åœ°åœ–å®¹å™¨ taiwan-map ä¸å­˜åœ¨');
          return;
        }

        // Leaflet å¯¦ä¾‹æª¢æŸ¥ï¼š_leaflet_id æ˜¯ Leaflet è‡ªå‹•æ·»åŠ çš„å…§éƒ¨å±¬æ€§
        // å¦‚æœå­˜åœ¨å‰‡è¡¨ç¤ºå·²ç¶“åˆå§‹åŒ–éåœ°åœ–å¯¦ä¾‹
        if (mapContainer._leaflet_id) {
          // æ¸…ç†èˆŠçš„ Leaflet å¯¦ä¾‹ï¼šé‡ç½®å…§éƒ¨ ID å’Œæ¸…ç©ºå®¹å™¨å…§å®¹
          mapContainer._leaflet_id = null; // é‡ç½® Leaflet å…§éƒ¨æ¨™è­˜
          mapContainer.innerHTML = ''; // æ¸…ç©ºå®¹å™¨å…§çš„æ‰€æœ‰ HTML å…§å®¹
        }

        // å‰µå»ºåœ°åœ–å¯¦ä¾‹ï¼Œè¨­å®šä¸­å¿ƒé»ç‚ºå°ç£ä¸­éƒ¨ï¼Œç§»é™¤ç‰ˆæ¬Šå’Œç¸®æ”¾æ§åˆ¶
        const map = L.map('taiwan-map', {
          zoomControl: false, // ç§»é™¤ç¸®æ”¾æŒ‰éˆ•
          attributionControl: false, // ç§»é™¤ç‰ˆæ¬Šbar
        }).setView([23.8, 120.9], 7);

        // æ·»åŠ  OpenStreetMap åœ–å±¤ï¼ˆç„¡ç‰ˆæ¬Šæ¨™ç¤ºï¼‰
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '', // ç§»é™¤ç‰ˆæ¬Šæ–‡å­—
        }).addTo(map);

        // ç²å–åŒ…å«"å¤§å­¸"æˆ–"å­¸é™¢"ä¸¦æœ‰åœ°ç†ä½ç½®çš„åŸ·è¡Œå–®ä½æ•¸æ“š
        const universityUnits = dataStore.getUniversityExecutingUnitsWithLocation;

        // è¼¸å‡ºé™¤éŒ¯è³‡è¨Š
        console.log('åœ°åœ–æ•¸æ“š:', {
          ç¸½å¤§å­¸å­¸é™¢æ•¸: universityUnits.length,
          æœ‰åœ°ç†ä½ç½®çš„æ•¸é‡: universityUnits.filter((u) => u.hasLocation).length,
          æ¨£æœ¬æ•¸æ“š: universityUnits.slice(0, 3),
        });

        // å¦‚æœæ²’æœ‰æ•¸æ“šï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯
        if (universityUnits.length === 0) {
          console.warn('æ²’æœ‰æ‰¾åˆ°åŒ…å«å¤§å­¸/å­¸é™¢ä¸”æœ‰åœ°ç†ä½ç½®çš„åŸ·è¡Œå–®ä½æ•¸æ“š');
          return;
        }

        // åœ¨åœ°åœ–ä¸Šæ·»åŠ åœ“åœˆæ¨™è¨˜ï¼Œå¤§å°åæ˜ æ¡ˆä»¶æ•¸
        universityUnits.forEach((unit) => {
          // è·³éæ²’æœ‰åœ°ç†ä½ç½®çš„å–®ä½
          if (!unit.hasLocation) return;

          // è¨ˆç®—åœ“åœˆå¤§å°ï¼šåŸºæ–¼æ¡ˆä»¶æ•¸çš„ç›¸å°å¤§å°
          // ä½¿ç”¨å°æ•¸æ¯”ä¾‹ç¢ºä¿è¦–è¦ºæ•ˆæœåˆç†
          const scaleFactor = 10; // ç¸®æ”¾å› å­ï¼Œèª¿æ•´æ•´é«”å¤§å°
          const radius = Math.sqrt((unit.å§”æ‰˜æ¡ˆä»¶æ•¸ * scaleFactor) / Math.PI); // ä½¿ç”¨å§”æ‰˜æ¡ˆä»¶æ•¸

          // å‰µå»ºåœ“åœˆæ¨™è¨˜
          const circle = L.circle([unit.lat, unit.lng], {
            color: 'var(--my-color-red)', // é‚Šæ¡†é¡è‰²
            fillColor: 'var(--my-color-red)', // å¡«å……é¡è‰²
            fillOpacity: 0.6, // é€æ˜åº¦
            radius: radius * 1000, // è½‰æ›ç‚ºå…¬å°º
            weight: 1, // é‚Šæ¡†å¯¬åº¦
          }).addTo(map);

          // å‰µå»ºè©³ç´°çš„å½ˆå‡ºè¦–çª—å…§å®¹
          const popupContent = `
            <div>
              <strong>${unit.name}</strong><br/>
              <div>
                <div>å§”æ‰˜æ¡ˆä»¶æ•¸: ${unit.å§”æ‰˜æ¡ˆä»¶æ•¸.toLocaleString()}</div>
                <div>å¹³å‡é‡‘é¡: ${Math.round(unit.æœ¬æœŸç¶“è²»å¹³å‡_åƒå…ƒ).toLocaleString()}(åƒå…ƒ)</div>
              </div>
            </div>
          `;

          // ç¶å®šå½ˆå‡ºè¦–çª—
          circle.bindPopup(popupContent, {
            maxWidth: 300,
          });

          // æ·»åŠ æ»‘é¼ æ‡¸åœæ•ˆæœ
          circle.on('mouseover', function () {
            this.setStyle({
              fillOpacity: 0.8,
              weight: 3,
            });
          });

          circle.on('mouseout', function () {
            this.setStyle({
              fillOpacity: 0.6,
              weight: 2,
            });
          });
        });
      };

      /**
       * æ–‡å­—é›²ç¹ªè£½å‡½æ•¸
       *
       * åŠŸèƒ½èªªæ˜ï¼š
       * ä½¿ç”¨ D3.js å‰µå»ºå­¸è¡“å–®ä½çš„æ–‡å­—é›²è¦–è¦ºåŒ–ï¼Œæ–‡å­—å¤§å°åæ˜ å„å–®ä½çš„å§”æ‰˜æ¡ˆä»¶æ•¸ã€‚
       * é€™ç‚ºç”¨æˆ¶æä¾›äº†å¦ä¸€ç¨®è¦–è§’ä¾†ç†è§£å­¸è¡“å–®ä½çš„æ¡ˆä»¶åˆ†å¸ƒæƒ…æ³ï¼Œæ–‡å­—è¶Šå¤§è¡¨ç¤ºæ¡ˆä»¶æ•¸è¶Šå¤šã€‚
       *
       * æŠ€è¡“å¯¦ç¾æ¶æ§‹ï¼š
       * - å¸ƒå±€ç®—æ³•ï¼šä½¿ç”¨ D3.js çš„ d3-cloud å¸ƒå±€ç®—æ³•ï¼Œå¯¦ç¾æ–‡å­—çš„éš¨æ©Ÿåˆ†å¸ƒ
       * - è¦–è¦ºåŒ–è¨­è¨ˆï¼šæ–‡å­—å¤§å°èˆ‡æ¡ˆä»¶æ•¸æˆæ­£æ¯”ï¼Œå¯¦ç¾æ•¸æ“šçš„è¦–è¦ºåŒ–è¡¨é”
       * - äº’å‹•åŠŸèƒ½ï¼šæ”¯æŒæ»‘é¼ æ‡¸åœæ•ˆæœï¼Œé¡¯ç¤ºè©³ç´°çš„çµ±è¨ˆä¿¡æ¯
       * - éŸ¿æ‡‰å¼è¨­è¨ˆï¼šè‡ªå‹•é©æ‡‰å®¹å™¨å°ºå¯¸ï¼Œæ”¯æŒä¸åŒè¢å¹•åˆ†è¾¨ç‡
       *
       * æ•¸æ“šè™•ç†é‚è¼¯ï¼š
       * 1. å¾ dataStore ç²å–å­¸è¡“å–®ä½æ•¸æ“šï¼ˆ"å­¸è¡“å–®ä½":"TRUE"ï¼‰
       * 2. éæ¿¾å‡ºæœ‰æ¡ˆä»¶æ•¸çš„å–®ä½ï¼Œé¿å…é¡¯ç¤ºé›¶æ¡ˆä»¶æ•¸çš„å–®ä½
       * 3. æ ¹æ“šæ¡ˆä»¶æ•¸è¨ˆç®—æ–‡å­—å¤§å°ï¼Œå¯¦ç¾æ•¸æ“šçš„è¦–è¦ºåŒ–è¡¨é”
       * 4. ä½¿ç”¨ d3-cloud ç®—æ³•è¨ˆç®—æ–‡å­—çš„éš¨æ©Ÿä½ç½®ï¼Œé¿å…é‡ç–Š
       *
       * è¦–è¦ºè¨­è¨ˆç‰¹é»ï¼š
       * - æ–‡å­—å¤§å°ç·¨ç¢¼ï¼šæ–‡å­—å¤§å°èˆ‡å§”æ‰˜æ¡ˆä»¶æ•¸æˆæ­£æ¯”
       * - é¡è‰²ç·¨ç¢¼ï¼šä½¿ç”¨æ¼¸è®Šè‰²å½©ï¼Œæ¡ˆä»¶æ•¸è¶Šå¤šé¡è‰²è¶Šæ·±
       * - éš¨æ©Ÿå¸ƒå±€ï¼šæ–‡å­—ä½ç½®éš¨æ©Ÿåˆ†å¸ƒï¼Œå‰µé€ è¦–è¦ºä¸Šçš„å‹•æ…‹æ„Ÿ
       * - æ‡¸åœæ•ˆæœï¼šæ»‘é¼ æ‡¸åœæ™‚æ–‡å­—è®Šå¤§è®Šæ·±ï¼Œæå‡ç”¨æˆ¶é«”é©—
       *
       * æ€§èƒ½å„ªåŒ–ï¼š
       * - åªé¡¯ç¤ºæœ‰æ¡ˆä»¶æ•¸çš„å­¸è¡“å–®ä½ï¼Œé¿å…ç„¡æ„ç¾©çš„è¦–è¦ºå…ƒç´ 
       * - ä½¿ç”¨ D3.js çš„éæ¸¡å‹•ç•«ï¼Œæå‡ç”¨æˆ¶é«”é©—
       * - åŠæ™‚æ¸…ç†èˆŠçš„æ–‡å­—é›²å…ƒç´ ï¼Œé˜²æ­¢è¨˜æ†¶é«”æ´©æ¼
       */
      const drawWordCloud = () => {
        // ç²å–æ–‡å­—é›²å®¹å™¨
        const container = d3.select('#word-cloud');
        if (container.empty()) {
          console.warn('æ–‡å­—é›²å®¹å™¨ #word-cloud ä¸å­˜åœ¨');
          return;
        }

        // æ¸…ç†å®¹å™¨
        container.selectAll('*').remove();

        // ç²å–å­¸è¡“å–®ä½æ•¸æ“š
        const academicUnits = dataStore.executingUnits.filter(
          (unit) => unit.å­¸è¡“å–®ä½ === 'TRUE' && unit.å§”æ‰˜æ¡ˆä»¶æ•¸ > 0
        );

        if (academicUnits.length === 0) {
          container
            .append('div')
            .attr('class', 'd-flex align-items-center justify-content-center h-100')
            .style('color', '#666')
            .text('ç„¡å­¸è¡“å–®ä½æ•¸æ“š');
          return;
        }

        // è¨ˆç®—å­—ç´šæ¯”ä¾‹å°ºï¼ˆå£“ç¸®å‹•æ…‹ç¯„åœï¼Œé¿å…å­—éå¤§ï¼‰
        const countsForScale = academicUnits.map((u) => u.å§”æ‰˜æ¡ˆä»¶æ•¸ || 0);
        const minCountForScale = d3.min(countsForScale) || 0;
        const maxCountForScale = d3.max(countsForScale) || 1;
        const sizeScale = d3
          .scalePow()
          .exponent(1.15)
          .domain([minCountForScale, maxCountForScale])
          .range([12, 44]);

        // æº–å‚™æ–‡å­—é›²æ•¸æ“šï¼ˆå¥—ç”¨ç¸®å°å¾Œå­—ç´šï¼‰
        const wordData = academicUnits.map((unit) => ({
          text: unit.name,
          size: Math.max(10, Math.round(sizeScale(unit.å§”æ‰˜æ¡ˆä»¶æ•¸ || 0))),
          count: unit.å§”æ‰˜æ¡ˆä»¶æ•¸,
          budget: unit.æœ¬æœŸç¶“è²»å¹³å‡_åƒå…ƒ || 0,
        }));

        // å‰µå»º SVG å®¹å™¨
        const containerWidth = container.node().getBoundingClientRect().width;
        const containerHeight = 400;

        const svg = container
          .append('svg')
          .attr('width', containerWidth)
          .attr('height', containerHeight);

        // CSS é¡è‰²è®Šæ•¸é™£åˆ—
        const cssColors = [
          'var(--my-color-red)',
          'var(--my-color-pink)',
          'var(--my-color-deeporange)',
          'var(--my-color-orange)',
          'var(--my-color-amber)',
          'var(--my-color-yellow)',
          'var(--my-color-lime)',
          'var(--my-color-light-green)',
          'var(--my-color-green)',
          'var(--my-color-teal)',
          'var(--my-color-cyan)',
          'var(--my-color-lightblue)',
          'var(--my-color-blue)',
          'var(--my-color-bluegrey)',
          'var(--my-color-indigo)',
          'var(--my-color-deeppurple)',
          'var(--my-color-purple)',
          'var(--my-color-brown)',
        ];

        // ä»¥èºæ—‹æœå°‹èˆ‡å¯¦éš›æ–‡å­—çŸ©å½¢ç¢°æ’æª¢æ¸¬çš„é˜²é‡ç–Šå¸ƒå±€
        const words = [];
        const placedRects = [];

        // æ¸¬é‡ç‰¹å®šå­—ç´šçš„æ–‡å­—å¯¦éš›å¯¬é«˜
        const measureText = (text, fontSize) => {
          const tempSvg = d3
            .select('body')
            .append('svg')
            .attr('width', 0)
            .attr('height', 0)
            .style('position', 'absolute')
            .style('left', '-9999px')
            .style('top', '-9999px');
          const tempText = tempSvg
            .append('text')
            .style('font-size', `${fontSize}px`)
            .style('font-family', 'Arial, Microsoft JhengHei, sans-serif')
            .text(text);
          const bbox = tempText.node().getBBox();
          tempSvg.remove();
          return { width: bbox.width, height: bbox.height };
        };

        const centerX = containerWidth / 2;
        const centerY = containerHeight / 2;
        const marginPad = 2;

        const rectsIntersect = (a, b) =>
          !(a.right < b.left || a.left > b.right || a.bottom < b.top || a.top > b.bottom);

        const sortedWordData = [...wordData].sort((a, b) => b.size - a.size);

        sortedWordData.forEach((word) => {
          let placed = false;

          // å˜—è©¦ç¸®å°å­—ç´šä»¥å¢åŠ å¯æ”¾ç½®æ©Ÿæœƒ
          for (let trySize = word.size; trySize >= 10 && !placed; trySize -= 2) {
            const { width, height } = measureText(word.text, trySize);

            // èºæ—‹æœå°‹ä½ç½®
            for (let t = 0; t < 2000 && !placed; t++) {
              const angle = 0.35 * t;
              const radius = 2 + 2 * angle;
              const x = centerX + radius * Math.cos(angle);
              const y = centerY + radius * Math.sin(angle);

              const rect = {
                left: x - width / 2 - marginPad,
                right: x + width / 2 + marginPad,
                top: y - height / 2 - marginPad,
                bottom: y + height / 2 + marginPad,
              };

              // é‚Šç•Œæª¢æŸ¥
              if (
                rect.left < 0 ||
                rect.right > containerWidth ||
                rect.top < 0 ||
                rect.bottom > containerHeight
              ) {
                continue;
              }

              // èˆ‡å·²æ”¾ç½®æ–‡å­—ç¢°æ’æª¢æ¸¬
              const hasCollision = placedRects.some((r) => rectsIntersect(rect, r));
              if (!hasCollision) {
                // æœä¸­å¿ƒæ–¹å‘ä½œå¾®ç§»æ“ å£“ï¼Œç›¡é‡è²¼è¿‘ä¸­å¿ƒ
                let curX = x;
                let curY = y;
                let curRect = { ...rect };
                for (let s = 0; s < 80; s++) {
                  const vx = centerX - curX;
                  const vy = centerY - curY;
                  const vlen = Math.hypot(vx, vy) || 1;
                  const step = 1; // æ¯æ­¥1px
                  const nx = curX + (vx / vlen) * step;
                  const ny = curY + (vy / vlen) * step;
                  const nrect = {
                    left: nx - width / 2 - marginPad,
                    right: nx + width / 2 + marginPad,
                    top: ny - height / 2 - marginPad,
                    bottom: ny + height / 2 + marginPad,
                  };
                  const outOfBounds =
                    nrect.left < 0 ||
                    nrect.right > containerWidth ||
                    nrect.top < 0 ||
                    nrect.bottom > containerHeight;
                  const collide = placedRects.some((r) => rectsIntersect(nrect, r));
                  if (outOfBounds || collide) break;
                  curX = nx;
                  curY = ny;
                  curRect = nrect;
                }

                const placedWord = {
                  text: word.text,
                  size: trySize,
                  budget: word.budget,
                  count: word.count,
                  x: curX,
                  y: curY,
                  color: cssColors[Math.floor(Math.random() * cssColors.length)],
                };
                words.push(placedWord);
                placedRects.push(curRect);
                placed = true;
              }
            }
          }
        });

        // ç¹ªè£½æ–‡å­—é›²
        svg
          .selectAll('text')
          .data(words)
          .enter()
          .append('text')
          .style('font-size', (d) => `${d.size}px`)
          .style('font-family', 'Arial, Microsoft JhengHei, sans-serif')
          .style('font-weight', 'bold')
          .style('fill', (d) => d.color)
          .style('cursor', 'pointer')
          .attr('text-anchor', 'middle')
          .attr('dominant-baseline', 'middle')
          .attr('x', (d) => d.x)
          .attr('y', (d) => d.y)
          // ç§»é™¤æ—‹è½‰ä»¥ç°¡åŒ–ç¢°æ’åˆ¤å®š
          .text((d) => d.text)
          .on('mouseover', function (event, d) {
            // æ‡¸åœæ•ˆæœ
            d3.select(this).style('fill', 'var(--my-color-red)');

            // é¡¯ç¤º tooltip
            const tooltip = d3
              .select('body')
              .append('div')
              .attr('class', 'word-cloud-tooltip')
              .style('position', 'absolute')
              .style('background', 'rgba(0, 0, 0, 0.8)')
              .style('color', 'white')
              .style('padding', '8px 12px')
              .style('border-radius', '4px')
              .style('font-size', '12px')
              .style('pointer-events', 'none')
              .style('z-index', '1000');

            tooltip.html(`
              <div><strong>${d.text}</strong></div>
              <div>å§”æ‰˜æ¡ˆä»¶æ•¸: ${d.count.toLocaleString()}</div>
              <div>å¹³å‡é‡‘é¡: ${Math.round(d.budget).toLocaleString()}(åƒå…ƒ)</div>
            `);
          })
          .on('mousemove', function (event) {
            // è·Ÿéš¨æ»‘é¼ ç§»å‹• tooltip
            d3.select('.word-cloud-tooltip')
              .style('left', event.pageX + 10 + 'px')
              .style('top', event.pageY - 10 + 'px');
          })
          .on('mouseout', function (event, d) {
            // æ¢å¾©åŸå§‹ç‹€æ…‹
            d3.select(this).style('font-size', `${d.size}px`).style('fill', d.color);

            // ç§»é™¤ tooltip
            d3.select('.word-cloud-tooltip').remove();
          });
      };

      // ==================== ç”Ÿå‘½é€±æœŸé‰¤å­ (Lifecycle Hooks) ====================
      // æœ¬å€åŸŸåŒ…å« Vue çµ„ä»¶çš„ç”Ÿå‘½é€±æœŸç®¡ç†å‡½æ•¸ï¼Œè² è²¬çµ„ä»¶çš„åˆå§‹åŒ–ã€æ•¸æ“šè¼‰å…¥ã€
      // åœ–è¡¨æ¸²æŸ“å’Œæ¸…ç†å·¥ä½œã€‚é€™äº›é‰¤å­ç¢ºä¿çµ„ä»¶åœ¨ä¸åŒç”Ÿå‘½é€±æœŸéšæ®µçš„æ­£ç¢ºè¡Œç‚ºã€‚

      /**
       * çµ„ä»¶æ›è¼‰ç”Ÿå‘½é€±æœŸé‰¤å­
       *
       * åŠŸèƒ½èªªæ˜ï¼š
       * åœ¨çµ„ä»¶ DOM æ›è¼‰å®Œæˆå¾ŒåŸ·è¡Œçš„åˆå§‹åŒ–é‚è¼¯ï¼Œé€™æ˜¯çµ„ä»¶ç”Ÿå‘½é€±æœŸä¸­æœ€é—œéµçš„éšæ®µã€‚
       * è² è²¬è¼‰å…¥æ‰€æœ‰å¿…è¦çš„æ•¸æ“šã€åˆå§‹åŒ–å„ç¨®åœ–è¡¨çµ„ä»¶ï¼Œä¸¦ç¢ºä¿æ•´å€‹åˆ†æç³»çµ±
       * èƒ½å¤ æ­£å¸¸é‹è¡Œã€‚é€™å€‹é‰¤å­ä½¿ç”¨ç•°æ­¥è™•ç†ï¼Œç¢ºä¿æ•¸æ“šè¼‰å…¥çš„å®Œæ•´æ€§å’Œå¯é æ€§ã€‚
       *
       * åŸ·è¡Œæµç¨‹è¨­è¨ˆï¼š
       * 1. æ•¸æ“šè¼‰å…¥éšæ®µï¼šå¾ dataStore è¼‰å…¥æ‰€æœ‰å¿…è¦çš„æ•¸æ“šæº
       *    - ä¸»ç®¡æ©Ÿé—œæ•¸æ“šï¼šåŒ…å«åŸºæœ¬ä¿¡æ¯å’Œçµ±è¨ˆæ•¸æ“š
       *    - åŸ·è¡Œå–®ä½æ•¸æ“šï¼šåŒ…å«å–®ä½ä¿¡æ¯å’Œåœ°ç†ä½ç½®
       *    - æ˜ å°„é—œä¿‚æ•¸æ“šï¼šä¸»ç®¡æ©Ÿé—œèˆ‡åŸ·è¡Œå–®ä½çš„åˆä½œé—œä¿‚
       *    - åœ°ç†ä½ç½®æ•¸æ“šï¼šåŸ·è¡Œå–®ä½çš„åº§æ¨™ä¿¡æ¯
       *
       * 2. DOM æ›´æ–°ç­‰å¾…ï¼šä½¿ç”¨ nextTick ç¢ºä¿ Vue çš„éŸ¿æ‡‰å¼æ›´æ–°å®Œæˆ
       *    - ç­‰å¾…æ¨¡æ¿æ¸²æŸ“å®Œæˆ
       *    - ç¢ºä¿æ‰€æœ‰ DOM å®¹å™¨éƒ½å·²æº–å‚™å°±ç·’
       *    - é¿å…åœ¨å®¹å™¨æœªæº–å‚™å¥½æ™‚é€²è¡Œåœ–è¡¨æ¸²æŸ“
       *
       * 3. åœ–è¡¨åˆå§‹åŒ–éšæ®µï¼šæŒ‰é †åºåˆå§‹åŒ–å„ç¨®è¦–è¦ºåŒ–çµ„ä»¶
       *    - ä¸»åœ–è¡¨ï¼šä¸»ç®¡æ©Ÿé—œæ¡ˆä»¶æ•¸çµ±è¨ˆåœ–è¡¨
       *    - å°åœ–è¡¨ï¼š12å€‹ä¸»ç®¡æ©Ÿé—œä¸‹å±¬åŸ·è¡Œå–®ä½åˆ†æåœ–è¡¨
       *    - åœ°åœ–ï¼šå°ç£åœ°åœ–ä¸Šçš„å­¸è¡“å–®ä½åˆ†å¸ƒ
       *    - ç¶²çµ¡åœ–ï¼šä¸»ç®¡æ©Ÿé—œèˆ‡åŸ·è¡Œå–®ä½çš„é—œä¿‚ç¶²çµ¡
       *
       * 4. éŒ¯èª¤è™•ç†å’Œèª¿è©¦ï¼šæä¾›è©³ç´°çš„è¼‰å…¥ç‹€æ…‹ä¿¡æ¯å’ŒéŒ¯èª¤è™•ç†
       *    - è¨˜éŒ„è¼‰å…¥éç¨‹ä¸­çš„é—œéµä¿¡æ¯
       *    - è¼¸å‡ºæ•¸æ“šçµ±è¨ˆä¿¡æ¯ï¼Œä¾¿æ–¼å•é¡Œè¨ºæ–·
       *    - è™•ç†è¼‰å…¥å¤±æ•—çš„æƒ…æ³ï¼Œæä¾›ç”¨æˆ¶å‹å¥½çš„éŒ¯èª¤æç¤º
       *
       * æŠ€è¡“ç‰¹é»ï¼š
       * - ç•°æ­¥è™•ç†ï¼šä½¿ç”¨ async/await ç¢ºä¿æ•¸æ“šè¼‰å…¥çš„é †åºæ€§å’Œå¯é æ€§
       * - éŒ¯èª¤è™•ç†ï¼šå®Œå–„çš„éŒ¯èª¤æ•ç²å’Œè™•ç†æ©Ÿåˆ¶
       * - æ€§èƒ½å„ªåŒ–ï¼šä¸¦è¡Œè¼‰å…¥æ•¸æ“šæºï¼Œæå‡è¼‰å…¥é€Ÿåº¦
       * - ç‹€æ…‹ç®¡ç†ï¼šèˆ‡ Pinia store ç·Šå¯†é›†æˆï¼Œå¯¦ç¾æ•¸æ“šçš„çµ±ä¸€ç®¡ç†
       */
      onMounted(async () => {
        // é–‹ç™¼èª¿è©¦ä¿¡æ¯ï¼šè¨˜éŒ„çµ„ä»¶åˆå§‹åŒ–é–‹å§‹
        // eslint-disable-next-line no-console
        console.log('æ¡ˆä»¶æ•¸çµ±è¨ˆé é¢å·²åˆå§‹åŒ–');

        // æ•¸æ“šè¼‰å…¥éšæ®µï¼šå¾ dataStore è¼‰å…¥æ‰€æœ‰å¿…è¦çš„æ•¸æ“š
        // await: ç­‰å¾…ç•°æ­¥æ“ä½œå®Œæˆï¼Œç¢ºä¿æ•¸æ“šæº–å‚™å°±ç·’
        // loadAllData(): dataStore ä¸­çš„æ–¹æ³•ï¼Œè¼‰å…¥ä¸»ç®¡æ©Ÿé—œã€åŸ·è¡Œå–®ä½ç­‰æ‰€æœ‰æ•¸æ“š
        await dataStore.loadAllData();

        // é–‹ç™¼èª¿è©¦ä¿¡æ¯ï¼šè¼¸å‡ºè¼‰å…¥ç‹€æ…‹è³‡è¨Šï¼Œå”åŠ©å•é¡Œè¨ºæ–·
        // eslint-disable-next-line no-console
        console.log('è³‡æ–™è¼‰å…¥ç‹€æ…‹:', {
          // åŸå§‹ä¸»ç®¡æ©Ÿé—œæ•¸æ“šçš„æ•¸é‡
          ä¸»ç®¡æ©Ÿé—œæ•¸é‡: dataStore.supervisorAgencies.length,
          // ä¸»ç®¡æ©Ÿé—œèˆ‡åŸ·è¡Œå–®ä½æ˜ å°„é—œä¿‚çš„æ•¸é‡
          æ˜ å°„è³‡æ–™æ•¸é‡: dataStore.supervisorExecutingMapping.length,
          // ç¶“éè™•ç†çš„å‰Nåä¸»ç®¡æ©Ÿé—œæ•¸é‡
          å‰ååä¸»ç®¡æ©Ÿé—œ: dataStore.getTopSupervisorAgencies.length,
          // ç•¶å‰è¼‰å…¥ç‹€æ…‹ï¼ˆå¸ƒæ—å€¼ï¼‰
          è¼‰å…¥ä¸­: dataStore.loading,
          // è¼‰å…¥éç¨‹ä¸­çš„éŒ¯èª¤ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
          éŒ¯èª¤: dataStore.error,
        });

        // DOM æ›´æ–°ç­‰å¾…ï¼šç¢ºä¿ Vue çš„éŸ¿æ‡‰å¼æ›´æ–°å®Œæˆå¾Œå†é€²è¡Œ DOM æ“ä½œ
        // nextTick(): Vue 3 æä¾›çš„æ–¹æ³•ï¼Œç­‰å¾…ä¸‹ä¸€å€‹ DOM æ›´æ–°é€±æœŸ
        // é€™ç¢ºä¿æ‰€æœ‰çš„æ¨¡æ¿æ¸²æŸ“å’Œæ¢ä»¶é¡¯ç¤ºéƒ½å·²å®Œæˆï¼ŒDOM å®¹å™¨å·²æº–å‚™å°±ç·’
        const redrawAll = () => {
          // ä¸»åœ–è¡¨åˆå§‹åŒ–ï¼šå‰µå»ºé…ç½®å°è±¡ä¸¦èª¿ç”¨ç¹ªåœ–å‡½æ•¸
          const mainChartConfig = {
            // DOM å®¹å™¨ IDï¼šå°æ‡‰æ¨¡æ¿ä¸­çš„ä¸»åœ–è¡¨å®¹å™¨
            containerId: 'main-chart',
            // åœ–è¡¨æ•¸æ“šï¼šèª¿ç”¨æ•¸æ“šæº–å‚™å‡½æ•¸ç²å–å‰8åä¸»ç®¡æ©Ÿé—œæ•¸æ“š
            data: prepareMainChartData(),
            // Y è»¸æ¨™ç±¤ï¼šæ ¹æ“šç”¨æˆ¶éœ€æ±‚ï¼Œè¨­ç‚ºç©ºå­—ä¸²ä¸é¡¯ç¤º
            yAxisLabel: '',
            // å®¹å™¨é«˜åº¦ï¼šèˆ‡åœ°åœ–é«˜åº¦å”èª¿ï¼ˆ160px barå€åŸŸ + 160pxæ–‡å­—å€åŸŸï¼‰
            containerHeight: 320,
          };
          // èª¿ç”¨ä¸»åœ–è¡¨ç¹ªè£½å‡½æ•¸ï¼šä½¿ç”¨é…ç½®å°è±¡å‰µå»ºä¸»çµ±è¨ˆåœ–è¡¨
          drawChart(mainChartConfig);

          // èª¿ç”¨å°åœ–è¡¨æ‰¹æ¬¡ç¹ªè£½å‡½æ•¸ï¼šç‚ºæ¯å€‹ä¸»ç®¡æ©Ÿé—œå‰µå»ºåŸ·è¡Œå–®ä½åœ–è¡¨
          drawSupervisorCharts();

          // èª¿ç”¨åœ°åœ–åˆå§‹åŒ–å‡½æ•¸ï¼šå‰µå»ºå°ç£åœ°åœ–ä¸¦æ·»åŠ å¤§å­¸/å­¸é™¢æ¨™è¨˜
          initMap();

          // èª¿ç”¨é—œä¿‚åœ–ç¹ªè£½å‡½æ•¸ï¼šå‰µå»ºä¸»ç®¡æ©Ÿé—œèˆ‡åŸ·è¡Œå–®ä½çš„ç¶²çµ¡é—œä¿‚åœ–
          drawNetworkGraph();

          // èª¿ç”¨æ–‡å­—é›²ç¹ªè£½å‡½æ•¸ï¼šå‰µå»ºå­¸è¡“å–®ä½æ¡ˆä»¶æ•¸æ–‡å­—é›²
          drawWordCloud();
        };

        nextTick(() => {
          redrawAll();
          let resizeTimer = null;
          const onResize = () => {
            if (resizeTimer) clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
              // æ¸…ç©ºä¸»è¦å®¹å™¨é¿å…é‡ç–Š
              d3.select('#main-chart').selectAll('*').remove();
              redrawAll();
            }, 200);
          };
          window.addEventListener('resize', onResize);
          CaseCount_onResize = onResize;
        });
      });

      /**
       * çµ„ä»¶å¸è¼‰ç”Ÿå‘½é€±æœŸé‰¤å­
       *
       * åŠŸèƒ½èªªæ˜ï¼š
       * åœ¨çµ„ä»¶å¾ DOM ä¸­ç§»é™¤å‰åŸ·è¡Œçš„æ¸…ç†å·¥ä½œï¼Œé€™æ˜¯çµ„ä»¶ç”Ÿå‘½é€±æœŸçš„æœ€å¾Œéšæ®µã€‚
       * è² è²¬æ¸…ç†çµ„ä»¶é‹è¡Œéç¨‹ä¸­å‰µå»ºçš„å„ç¨®è³‡æºï¼Œé˜²æ­¢è¨˜æ†¶é«”æ´©æ¼å’Œ DOM æ±¡æŸ“ï¼Œ
       * ç¢ºä¿çµ„ä»¶èƒ½å¤ å®‰å…¨åœ°å¸è¼‰ï¼Œä¸¦ä¸”ä¸æœƒå½±éŸ¿å…¶ä»–çµ„ä»¶æˆ–é é¢çš„æ­£å¸¸é‹è¡Œã€‚
       *
       * æ¸…ç†å·¥ä½œçš„é‡è¦æ€§ï¼š
       * 1. è¨˜æ†¶é«”ç®¡ç†ï¼šæ¸…ç† D3.js å‰µå»ºçš„å¤§å‹æ•¸æ“šçµæ§‹å’Œäº‹ä»¶ç›£è½å™¨
       * 2. DOM æ¸…ç†ï¼šç§»é™¤å¯èƒ½æ®˜ç•™åœ¨å…¨åŸŸç¯„åœçš„ DOM å…ƒç´ 
       * 3. äº‹ä»¶æ¸…ç†ï¼šè§£é™¤äº‹ä»¶ç¶å®šï¼Œé˜²æ­¢äº‹ä»¶ç›£è½å™¨æ´©æ¼
       * 4. è³‡æºé‡‹æ”¾ï¼šé‡‹æ”¾åœ–è¡¨ç›¸é—œçš„è¨ˆç®—è³‡æºå’Œç·©å­˜
       *
       * æ¸…ç†ç­–ç•¥è¨­è¨ˆï¼š
       * - ä¸»å‹•æ¸…ç†ï¼šåœ¨çµ„ä»¶å¸è¼‰æ™‚ä¸»å‹•æ¸…ç†æ‰€æœ‰å‰µå»ºçš„è³‡æº
       * - é¸æ“‡æ€§æ¸…ç†ï¼šé‡å°ç‰¹å®šçš„å…ƒç´ é¡åˆ¥é€²è¡Œæ¸…ç†ï¼Œé¿å…å½±éŸ¿å…¶ä»–çµ„ä»¶
       * - å®‰å…¨æ¸…ç†ï¼šä½¿ç”¨ try-catch åŒ…è£æ¸…ç†é‚è¼¯ï¼Œç¢ºä¿æ¸…ç†éç¨‹ä¸æœƒå‡ºéŒ¯
       * - å®Œæ•´æ€§æª¢æŸ¥ï¼šæ¸…ç†å®Œæˆå¾Œé€²è¡Œæª¢æŸ¥ï¼Œç¢ºä¿æ²’æœ‰éºæ¼çš„è³‡æº
       *
       * æ³¨æ„äº‹é …ï¼š
       * ç”±æ–¼åœ¨åœ–è¡¨é‡ç¹ªæ™‚ä½¿ç”¨äº† selectAll('*').remove()ï¼Œå¤§éƒ¨åˆ† DOM å…ƒç´ çš„
       * æ¸…ç†å·¥ä½œå·²ç¶“åœ¨é‡ç¹ªéç¨‹ä¸­è‡ªå‹•å®Œæˆã€‚é€™å€‹é‰¤å­ä¸»è¦è² è²¬æ¸…ç†é‚£äº›å¯èƒ½
       * æ®˜ç•™åœ¨å…¨åŸŸç¯„åœæˆ–éœ€è¦ç‰¹æ®Šè™•ç†çš„è³‡æºã€‚
       */
      let CaseCount_onResize = null;
      onUnmounted(() => {
        // æ¸…ç† D3.js å‰µå»ºçš„å…¨åŸŸåœ–è¡¨æ¨™ç±¤å…ƒç´ 
        // selectAll('.bar-label'): é¸æ“‡æ‰€æœ‰å…·æœ‰ 'bar-label' é¡åˆ¥çš„å…ƒç´ 
        // remove(): å¾ DOM ä¸­ç§»é™¤é¸ä¸­çš„å…ƒç´ ï¼Œé‡‹æ”¾è¨˜æ†¶é«”
        // é€™ç¢ºä¿çµ„ä»¶å¸è¼‰æ™‚ä¸æœƒç•™ä¸‹å­¤ç«‹çš„ DOM å…ƒç´ 
        d3.selectAll('.bar-label').remove();

        // æ¸…ç†ç¶²çµ¡åœ–çš„ tooltip å…ƒç´ ï¼Œé¿å…è¨˜æ†¶é«”æ´©æ¼
        d3.selectAll('.network-tooltip').remove();

        // æ¸…ç†æ–‡å­—é›²çš„ tooltip å…ƒç´ ï¼Œé¿å…è¨˜æ†¶é«”æ´©æ¼
        d3.selectAll('.word-cloud-tooltip').remove();
        if (CaseCount_onResize) window.removeEventListener('resize', CaseCount_onResize);
      });

      // ==================== è¿”å›å°è±¡ (Return Object) ====================
      // åœ¨ Vue 3 Composition API ä¸­ï¼Œsetup å‡½æ•¸å¿…é ˆè¿”å›ä¸€å€‹å°è±¡ï¼Œ
      // é€™å€‹å°è±¡åŒ…å«æ¨¡æ¿ä¸­éœ€è¦ä½¿ç”¨çš„æ‰€æœ‰éŸ¿æ‡‰å¼æ•¸æ“šã€è¨ˆç®—å±¬æ€§å’Œæ–¹æ³•ã€‚
      // è¿”å›çš„å°è±¡æœƒèˆ‡æ¨¡æ¿é€²è¡ŒéŸ¿æ‡‰å¼ç¶å®šï¼Œç•¶æ•¸æ“šè®ŠåŒ–æ™‚ï¼Œæ¨¡æ¿æœƒè‡ªå‹•æ›´æ–°ã€‚

      return {
        // æ•¸æ“šç®¡ç† Store å¯¦ä¾‹
        // æä¾›çµ¦æ¨¡æ¿ä½¿ç”¨çš„ Pinia store å¯¦ä¾‹ï¼ŒåŒ…å«æ‰€æœ‰æ•¸æ“šè¼‰å…¥ã€è™•ç†å’Œç‹€æ…‹ç®¡ç†åŠŸèƒ½
        // æ¨¡æ¿å¯ä»¥é€šé dataStore.loadingã€dataStore.supervisorAgencies ç­‰æ–¹å¼è¨ªå•æ•¸æ“šç‹€æ…‹
        dataStore,

        // èª¿è©¦ä¿¡æ¯è¨ˆç®—å±¬æ€§
        // æä¾›çµ¦æ¨¡æ¿çš„èª¿è©¦å’Œç‹€æ…‹é¡¯ç¤ºæ•¸æ“šï¼ŒåŒ…å«è¼‰å…¥ç‹€æ…‹ã€éŒ¯èª¤ä¿¡æ¯ã€æ•¸æ“šçµ±è¨ˆç­‰é—œéµä¿¡æ¯
        // ç”¨æ–¼æ¨¡æ¿ä¸­çš„æ¢ä»¶æ¸²æŸ“ï¼Œé¡¯ç¤ºè¼‰å…¥ä¸­ã€éŒ¯èª¤æˆ–æ•¸æ“šç‹€æ…‹
        debugInfo,

        // ä¸»ç®¡æ©Ÿé—œå°åœ–è¡¨æ•¸æ“šè¨ˆç®—å±¬æ€§
        // æä¾›å‰12åä¸»ç®¡æ©Ÿé—œçš„åœ–è¡¨é…ç½®æ•¸æ“šï¼Œæ¯å€‹ä¸»ç®¡æ©Ÿé—œå°æ‡‰ä¸€å€‹å°åœ–è¡¨
        // æ¨¡æ¿ä¸­çš„ v-for æŒ‡ä»¤ä½¿ç”¨æ­¤æ•¸æ“šä¾†å‹•æ…‹ç”Ÿæˆ12å€‹å°åœ–è¡¨ï¼Œé¡¯ç¤ºå„æ©Ÿé—œçš„åŸ·è¡Œå–®ä½åˆ†å¸ƒ
        getSupervisorChartsData,
        exportContainerSvgAsPng,
      };
    }, // setup å‡½æ•¸çµæŸ
  }; // Vue çµ„ä»¶é…ç½®å°è±¡çµæŸ
</script>

<template>
  <div class="case-count-container">
    <div class="w-100 px-3">
      <div class="row">
        <div class="col-6">
          <div class="chart-container my-bgcolor-white rounded-4 border py-3">
            <div class="position-relative">
              <button
                class="btn btn-sm btn-outline-secondary position-absolute"
                style="
                  top: 8px;
                  right: 8px;
                  z-index: 2;
                  color: var(--my-color-gray-400);
                  border-color: var(--my-color-gray-400);
                "
                title="ä¸‹è¼‰ PNG"
                @click="exportContainerSvgAsPng('main-chart', 'æ¡ˆä»¶æ•¸_ä¸»åœ–è¡¨.png')"
              >
                <i class="fa-solid fa-download"></i>
              </button>
              <div class="d-flex justify-content-center my-title-md-black">
                ä¸»ç®¡æ©Ÿé—œæ¡ˆä»¶æ•¸çµ±è¨ˆ (å‰12å)
              </div>
            </div>
            <div v-if="debugInfo.error" class="alert alert-danger mb-3">
              è¼‰å…¥éŒ¯èª¤ï¼š{{ debugInfo.error }}
            </div>
            <div v-if="debugInfo.loading" class="text-center text-muted mb-3">è¼‰å…¥ä¸­...</div>

            <div
              v-if="!debugInfo.hasData && !debugInfo.loading && !debugInfo.error"
              class="text-center text-muted mb-3"
            >
              ç„¡è³‡æ–™
            </div>

            <div id="main-chart" style="min-height: 480px"></div>
          </div>
        </div>

        <div class="col-6">
          <div class="chart-container my-bgcolor-white rounded-4 border pt-3">
            <div class="d-flex justify-content-center my-title-md-black pb-3">
              å¤§å­¸/å­¸é™¢æ¡ˆä»¶æ•¸åˆ†å¸ƒ
            </div>
            <div id="taiwan-map" style="height: 480px; border-radius: 0 0 1rem 1rem"></div>
          </div>
        </div>
      </div>

      <div class="row">
        <div v-for="chartData in getSupervisorChartsData" :key="chartData.id" class="col-3 mt-4">
          <div class="chart-container my-bgcolor-white rounded-4 border py-3">
            <div class="d-flex justify-content-center my-title-md-black">
              {{ chartData.title }}
            </div>

            <div class="position-relative">
              <button
                class="btn btn-sm btn-outline-secondary position-absolute"
                style="
                  top: 8px;
                  right: 8px;
                  z-index: 2;
                  color: var(--my-color-gray-400);
                  border-color: var(--my-color-gray-400);
                "
                title="ä¸‹è¼‰ PNG"
                @click="exportContainerSvgAsPng(chartData.id, chartData.title + '_å°åœ–è¡¨.png')"
              >
                <i class="fa-solid fa-download"></i>
              </button>
              <div :id="chartData.id" style="min-height: 320px"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-12 mt-4">
          <div class="my-bgcolor-white rounded-4 border p-3 position-relative">
            <button
              class="btn btn-sm btn-outline-secondary position-absolute"
              style="
                top: 8px;
                right: 8px;
                z-index: 2;
                color: var(--my-color-gray-400);
                border-color: var(--my-color-gray-400);
              "
              title="ä¸‹è¼‰ PNG"
              @click="exportContainerSvgAsPng('network-graph', 'æ¡ˆä»¶æ•¸_é—œä¿‚åœ–.png')"
            >
              <i class="fa-solid fa-download"></i>
            </button>
            <div class="d-flex justify-content-center my-title-md-black mb-3">
              ä¸»ç®¡æ©Ÿé—œèˆ‡åŸ·è¡Œå–®ä½é—œä¿‚ç¶²çµ¡åœ–
            </div>

            <div id="network-graph" style="height: 600px; width: 100%"></div>
          </div>
        </div>
      </div>

      <!-- æ–‡å­—é›²ç¨ç«‹æ¡† -->
      <div class="row">
        <div class="col-12 mt-4">
          <div class="my-bgcolor-white rounded-4 border p-3">
            <div class="d-flex justify-content-center my-title-md-black mb-3">
              å­¸è¡“å–®ä½æ¡ˆä»¶æ•¸æ–‡å­—é›²
            </div>
            <div id="word-cloud" style="height: 400px; width: 100%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<style scoped>
  /* ä½¿ç”¨Bootstrapå’Œcommon.cssçš„æ¨£å¼ï¼Œé«˜åº¦è¨­å®šä½¿ç”¨å…§è¯style */
</style>
